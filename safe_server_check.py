#!/usr/bin/env python3
"""
–ê–ö–ö–£–†–ê–¢–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –°–ï–†–í–ï–†–ê 72.56.66.228
–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑ —Ä–∏—Å–∫–∞ —Å–ª–æ–º–∞—Ç—å —á—Ç–æ-–ª–∏–±–æ
"""

import requests
import time
import json
from datetime import datetime

def safe_ping_test():
    """–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π ping —Ç–µ—Å—Ç"""
    print("üîç –ê–ö–ö–£–†–ê–¢–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –°–ï–†–í–ï–†–ê 72.56.66.228")
    print("=" * 60)
    print("üì° –®–ê–ì 1: –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏...")
    
    try:
        # –û—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–∞–π–º–∞—É—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        response = requests.get("http://72.56.66.228", timeout=5)
        print(f"   üìä HTTP —Å—Ç–∞—Ç—É—Å: {response.status_code}")
        
        if response.status_code == 200:
            print("   ‚úÖ –°–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ")
            return "working"
        elif response.status_code == 502:
            print("   ‚ö†Ô∏è 502 Bad Gateway - —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω–æ")
            return "server_ok_app_down"
        elif response.status_code == 404:
            print("   ‚ö†Ô∏è 404 Not Found - —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ")
            return "server_ok_app_missing"
        else:
            print(f"   ‚ö†Ô∏è –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å: {response.status_code}")
            return "unknown"
            
    except requests.exceptions.Timeout:
        print("   ‚è∞ –¢–∞–π–º–∞—É—Ç - —Å–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç")
        return "timeout"
    except requests.exceptions.ConnectionError:
        print("   üîå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è - —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
        return "connection_error"
    except Exception as e:
        print(f"   ‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
        return "error"

def safe_endpoint_check():
    """–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ endpoints"""
    print("\nüì° –®–ê–ì 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö endpoints...")
    
    # –¢–æ–ª—å–∫–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ GET –∑–∞–ø—Ä–æ—Å—ã
    safe_endpoints = [
        ("/", "–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞"),
        ("/module/trends", "–ú–æ–¥—É–ª—å —Ç—Ä–µ–Ω–¥–æ–≤"),
        ("/module/vacancies", "–ú–æ–¥—É–ª—å –≤–∞–∫–∞–Ω—Å–∏–π"),
        ("/module/experts", "–ú–æ–¥—É–ª—å —ç–∫—Å–ø–µ—Ä—Ç–æ–≤")
    ]
    
    working_count = 0
    
    for endpoint, description in safe_endpoints:
        try:
            # –ö–æ—Ä–æ—Ç–∫–∏–π —Ç–∞–π–º–∞—É—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            response = requests.get(f"http://72.56.66.228{endpoint}", timeout=3)
            
            if response.status_code == 200:
                print(f"   ‚úÖ {description}: —Ä–∞–±–æ—Ç–∞–µ—Ç")
                working_count += 1
            elif response.status_code == 404:
                print(f"   ‚ö†Ô∏è {description}: –Ω–µ –Ω–∞–π–¥–µ–Ω (404)")
            else:
                print(f"   ‚ö†Ô∏è {description}: —Å—Ç–∞—Ç—É—Å {response.status_code}")
                
        except requests.exceptions.Timeout:
            print(f"   ‚è∞ {description}: —Ç–∞–π–º–∞—É—Ç")
        except Exception as e:
            print(f"   ‚ùå {description}: –æ—à–∏–±–∫–∞ - {str(e)[:50]}...")
    
    return working_count

def safe_api_check():
    """–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ API"""
    print("\nüì° –®–ê–ì 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ API (—Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ)...")
    
    try:
        # –¢–æ–ª—å–∫–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π GET –∑–∞–ø—Ä–æ—Å –∫ API
        response = requests.get("http://72.56.66.228/api/competitors", timeout=5)
        
        if response.status_code == 200:
            print("   ‚úÖ API –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤: —Ä–∞–±–æ—Ç–∞–µ—Ç")
            return True
        else:
            print(f"   ‚ö†Ô∏è API –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤: —Å—Ç–∞—Ç—É—Å {response.status_code}")
            return False
            
    except requests.exceptions.Timeout:
        print("   ‚è∞ API –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤: —Ç–∞–π–º–∞—É—Ç")
        return False
    except Exception as e:
        print(f"   ‚ùå API –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤: –æ—à–∏–±–∫–∞ - {str(e)[:50]}...")
        return False

def analyze_status(server_status, working_endpoints, api_working):
    """–ê–Ω–∞–ª–∏–∑ —Å—Ç–∞—Ç—É—Å–∞ –±–µ–∑ —Ä–∏—Å–∫–∞"""
    print("\n" + "=" * 60)
    print("üìä –ê–ù–ê–õ–ò–ó –°–¢–ê–¢–£–°–ê –°–ï–†–í–ï–†–ê")
    print("=" * 60)
    
    if server_status == "working":
        if working_endpoints >= 3:
            print("üéâ –û–¢–õ–ò–ß–ù–û! –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é!")
            print("‚úÖ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω")
            print("‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ")
            print(f"‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç {working_endpoints}/4 –º–æ–¥—É–ª–µ–π")
            if api_working:
                print("‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç")
            print("\nüìã –°–ò–°–¢–ï–ú–ê –ì–û–¢–û–í–ê –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ!")
            return "excellent"
        else:
            print("‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –º–æ–¥—É–ª—è–º–∏")
            print(f"‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ {working_endpoints}/4 –º–æ–¥—É–ª–µ–π")
            return "partial"
            
    elif server_status == "server_ok_app_down":
        print("‚ö†Ô∏è –°–ï–†–í–ï–† –†–ê–ë–û–¢–ê–ï–¢, –ù–û –ü–†–ò–õ–û–ñ–ï–ù–ò–ï –ù–ï –ó–ê–ü–£–©–ï–ù–û")
        print("üîß –ù–£–ñ–ù–û –ó–ê–ü–£–°–¢–ò–¢–¨ –ü–†–ò–õ–û–ñ–ï–ù–ò–ï:")
        print("1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É")
        print("2. –ù–∞–π–¥–∏—Ç–µ –ø–∞–ø–∫—É —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º")
        print("3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: python3 app.py")
        return "app_down"
        
    elif server_status == "server_ok_app_missing":
        print("‚ö†Ô∏è –°–ï–†–í–ï–† –†–ê–ë–û–¢–ê–ï–¢, –ù–û –ü–†–ò–õ–û–ñ–ï–ù–ò–ï –ù–ï –ù–ê–°–¢–†–û–ï–ù–û")
        print("üîß –ù–£–ñ–ù–û –†–ê–ó–í–ï–†–ù–£–¢–¨ –ü–†–ò–õ–û–ñ–ï–ù–ò–ï:")
        print("1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä")
        print("2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é")
        print("3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ")
        return "app_missing"
        
    elif server_status == "timeout":
        print("‚ùå –°–ï–†–í–ï–† –ù–ï –û–¢–í–ï–ß–ê–ï–¢")
        print("üîß –í–û–ó–ú–û–ñ–ù–´–ï –ü–†–ò–ß–ò–ù–´:")
        print("1. –°–µ—Ä–≤–µ—Ä –≤—ã–∫–ª—é—á–µ–Ω")
        print("2. –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é")
        print("3. –°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω")
        return "server_down"
        
    elif server_status == "connection_error":
        print("‚ùå –û–®–ò–ë–ö–ê –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø")
        print("üîß –í–û–ó–ú–û–ñ–ù–´–ï –ü–†–ò–ß–ò–ù–´:")
        print("1. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π IP –∞–¥—Ä–µ—Å")
        print("2. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ñ–∞–π—Ä–≤–æ–ª–æ–º")
        print("3. –ü—Ä–æ–±–ª–µ–º—ã —Å DNS")
        return "connection_error"
        
    else:
        print("‚ùì –ù–ï–ò–ó–í–ï–°–¢–ù–´–ô –°–¢–ê–¢–£–°")
        print("üîß –¢–†–ï–ë–£–ï–¢–°–Ø –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê")
        return "unknown"

def show_safe_next_steps(status):
    """–ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏"""
    print("\n" + "=" * 60)
    print("üìã –ë–ï–ó–û–ü–ê–°–ù–´–ï –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò")
    print("=" * 60)
    
    if status == "excellent":
        print("üéâ –°–ò–°–¢–ï–ú–ê –†–ê–ë–û–¢–ê–ï–¢ –û–¢–õ–ò–ß–ù–û!")
        print("‚úÖ –ù–∏–∫–∞–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è")
        print("üåê –ú–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å: http://72.56.66.228/")
        
    elif status == "partial":
        print("‚ö†Ô∏è –°–ò–°–¢–ï–ú–ê –†–ê–ë–û–¢–ê–ï–¢ –ß–ê–°–¢–ò–ß–ù–û")
        print("üîß –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:")
        print("1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è")
        print("2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –º–æ–¥—É–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã")
        print("3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º")
        
    elif status == "app_down":
        print("üîß –ù–£–ñ–ù–û –ó–ê–ü–£–°–¢–ò–¢–¨ –ü–†–ò–õ–û–ñ–ï–ù–ò–ï")
        print("üìã –ë–ï–ó–û–ü–ê–°–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø:")
        print("1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É —á–µ—Ä–µ–∑ SSH")
        print("2. –ù–∞–π–¥–∏—Ç–µ –ø–∞–ø–∫—É —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º")
        print("3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –µ—Å—Ç—å –ª–∏ —Ñ–∞–π–ª app.py")
        print("4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: python3 app.py")
        print("5. –ò–ª–∏ –≤ —Ñ–æ–Ω–µ: nohup python3 app.py > app.log 2>&1 &")
        
    elif status == "app_missing":
        print("üîß –ù–£–ñ–ù–û –†–ê–ó–í–ï–†–ù–£–¢–¨ –ü–†–ò–õ–û–ñ–ï–ù–ò–ï")
        print("üìã –ë–ï–ó–û–ü–ê–°–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø:")
        print("1. –°–æ–∑–¥–∞–π—Ç–µ –ø–∞–∫–µ—Ç: python3 deploy_to_server.py")
        print("2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä")
        print("3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é")
        print("4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ")
        
    elif status in ["server_down", "connection_error"]:
        print("‚ùå –ü–†–û–ë–õ–ï–ú–´ –° –°–ï–†–í–ï–†–û–ú")
        print("üìã –ë–ï–ó–û–ü–ê–°–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø:")
        print("1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞")
        print("2. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É")
        print("3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ç–∏")
        
    else:
        print("‚ùì –¢–†–ï–ë–£–ï–¢–°–Ø –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê")
        print("üìã –ë–ï–ó–û–ü–ê–°–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø:")
        print("1. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç")
        print("2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞")
        print("3. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É")

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è - –∞–∫–∫—É—Ä–∞—Ç–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞"""
    print("üõ°Ô∏è –ê–ö–ö–£–†–ê–¢–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –°–ï–†–í–ï–†–ê")
    print("–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑ —Ä–∏—Å–∫–∞ —Å–ª–æ–º–∞—Ç—å —á—Ç–æ-–ª–∏–±–æ")
    print("=" * 60)
    
    # –®–∞–≥ 1: –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    server_status = safe_ping_test()
    
    # –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ endpoints (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç)
    working_endpoints = 0
    if server_status in ["working", "server_ok_app_down", "server_ok_app_missing"]:
        working_endpoints = safe_endpoint_check()
    
    # –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ API (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç)
    api_working = False
    if server_status in ["working", "server_ok_app_down", "server_ok_app_missing"]:
        api_working = safe_api_check()
    
    # –ê–Ω–∞–ª–∏–∑ —Å—Ç–∞—Ç—É—Å–∞
    status = analyze_status(server_status, working_endpoints, api_working)
    
    # –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏
    show_safe_next_steps(status)
    
    print("\n" + "=" * 60)
    print("üõ°Ô∏è –ü–†–û–í–ï–†–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê –ë–ï–ó–û–ü–ê–°–ù–û")
    print("–ù–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –Ω–µ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ")
    print("=" * 60)

if __name__ == "__main__":
    main()
