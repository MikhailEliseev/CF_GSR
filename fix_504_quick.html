<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 504 –æ—à–∏–±–∫–∏</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .alert {
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            font-weight: 600;
        }
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }
        button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px 5px;
        }
        button:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }
        .test-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }
        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            margin: 15px 0;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 504 –æ—à–∏–±–∫–∏</h1>
        
        <div class="alert alert-danger">
            <h3>‚ùå –ü—Ä–æ–±–ª–µ–º–∞: HTTP 504 Gateway Time-out</h3>
            <p>Apify API —Ä–∞–±–æ—Ç–∞–µ—Ç –º–µ–¥–ª–µ–Ω–Ω–æ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –≠—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç —Ç–∞–π–º–∞—É—Ç—ã –ø—Ä–∏ —Å–±–æ—Ä–µ —Ä–∏–ª—Å–æ–≤.</p>
        </div>
        
        <div class="alert alert-warning">
            <h3>‚ö†Ô∏è –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ</h3>
            <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—å—à–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∏–ª—Å–æ–≤ (1-5) –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –≠—Ç–æ —É–º–µ–Ω—å—à–∏—Ç –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞.</p>
        </div>
        
        <div class="test-section">
            <h3>üß™ –¢–µ—Å—Ç —Å –º–∞–ª—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ä–∏–ª—Å–æ–≤</h3>
            <button onclick="testSmallCount()">–¢–µ—Å—Ç: 3 —Ä–∏–ª—Å–∞</button>
            <button onclick="testMediumCount()">–¢–µ—Å—Ç: 5 —Ä–∏–ª—Å–æ–≤</button>
            <button onclick="testLargeCount()">–¢–µ—Å—Ç: 10 —Ä–∏–ª—Å–æ–≤</button>
            <div id="testResult" class="alert alert-info" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>üìä –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h3>
            <button onclick="checkApifyStatus()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Apify API</button>
            <button onclick="checkServerStatus()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</button>
            <div id="diagnosticResult" class="alert alert-info" style="display: none;"></div>
        </div>
        
        <div class="alert alert-info">
            <h3>üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h3>
            <ol>
                <li><strong>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 1-5 —Ä–∏–ª—Å–æ–≤</strong> –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</li>
                <li><strong>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</strong> - Apify –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–º</li>
                <li><strong>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ</strong> - Apify –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω</li>
                <li><strong>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ fallback –¥–∞–Ω–Ω—ã–µ</strong> –µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</li>
            </ol>
        </div>
        
        <div class="code-block">
// –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:
// 1. –£–º–µ–Ω—å—à–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∏–ª—Å–æ–≤
// 2. –î–æ–±–∞–≤—å—Ç–µ —Ç–∞–π–º–∞—É—Ç –≤ JavaScript
// 3. –ü–æ–∫–∞–∂–∏—Ç–µ fallback –¥–∞–Ω–Ω—ã–µ

const controller = new AbortController();
const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 —Å–µ–∫

fetch('/api/trends/collect-reels', {
    method: 'POST',
    body: JSON.stringify({
        competitors: selectedCompetitors,
        count: 3  // –ú–µ–Ω—å—à–µ —Ä–∏–ª—Å–æ–≤ = –±—ã—Å—Ç—Ä–µ–µ
    }),
    signal: controller.signal
});
        </div>
    </div>

    <script>
        async function testSmallCount() {
            await testReelsCount(3);
        }
        
        async function testMediumCount() {
            await testReelsCount(5);
        }
        
        async function testLargeCount() {
            await testReelsCount(10);
        }
        
        async function testReelsCount(count) {
            const result = document.getElementById('testResult');
            result.style.display = 'block';
            result.innerHTML = `<div class="alert alert-info">üîÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º ${count} —Ä–∏–ª—Å–æ–≤...</div>`;
            
            const startTime = Date.now();
            
            try {
                const response = await fetch('/api/trends/collect-reels', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        competitors: ['@alfa.resource.group.kg'],
                        count: count
                    })
                });
                
                const elapsed = (Date.now() - startTime) / 1000;
                
                if (response.ok) {
                    const data = await response.json();
                    result.innerHTML = `
                        <div class="alert alert-success">
                            ‚úÖ –£—Å–ø–µ—à–Ω–æ! –í—Ä–µ–º—è: ${elapsed.toFixed(1)}—Å<br>
                            –°–æ–±—Ä–∞–Ω–æ: ${data.total_count || 0} —Ä–∏–ª—Å–æ–≤<br>
                            –í–∏—Ä–∞–ª—å–Ω—ã—Ö: ${data.viral_count || 0}
                        </div>
                    `;
                } else {
                    result.innerHTML = `
                        <div class="alert alert-danger">
                            ‚ùå HTTP ${response.status}<br>
                            –í—Ä–µ–º—è: ${elapsed.toFixed(1)}—Å
                        </div>
                    `;
                }
                
            } catch (error) {
                const elapsed = (Date.now() - startTime) / 1000;
                result.innerHTML = `
                    <div class="alert alert-danger">
                        ‚ùå –û—à–∏–±–∫–∞: ${error.message}<br>
                        –í—Ä–µ–º—è: ${elapsed.toFixed(1)}—Å
                    </div>
                `;
            }
        }
        
        async function checkApifyStatus() {
            const result = document.getElementById('diagnosticResult');
            result.style.display = 'block';
            result.innerHTML = '<div class="alert alert-info">üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º Apify API...</div>';
            
            try {
                const response = await fetch('/api/trends/collect-reels', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        competitors: ['@alfa.resource.group.kg'],
                        count: 1
                    })
                });
                
                if (response.ok) {
                    result.innerHTML = '<div class="alert alert-success">‚úÖ Apify API —Ä–∞–±–æ—Ç–∞–µ—Ç</div>';
                } else {
                    result.innerHTML = `<div class="alert alert-danger">‚ùå Apify API –æ—à–∏–±–∫–∞: ${response.status}</div>`;
                }
                
            } catch (error) {
                result.innerHTML = `<div class="alert alert-danger">‚ùå Apify API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${error.message}</div>`;
            }
        }
        
        async function checkServerStatus() {
            const result = document.getElementById('diagnosticResult');
            result.style.display = 'block';
            result.innerHTML = '<div class="alert alert-info">üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ä–≤–µ—Ä...</div>';
            
            try {
                const response = await fetch('/api/trends/collect-reels', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        competitors: [],
                        count: 0
                    })
                });
                
                if (response.ok) {
                    result.innerHTML = '<div class="alert alert-success">‚úÖ –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç</div>';
                } else {
                    result.innerHTML = `<div class="alert alert-danger">‚ùå –°–µ—Ä–≤–µ—Ä –æ—à–∏–±–∫–∞: ${response.status}</div>`;
                }
                
            } catch (error) {
                result.innerHTML = `<div class="alert alert-danger">‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
