#!/usr/bin/env python3
"""
–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ - —É–±–∏—Ä–∞–µ–º –¥–µ–º–æ –¥–∞–Ω–Ω—ã–µ
"""

import requests
import json
import time

def check_demo_data():
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–µ–º–æ –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"""
    print("üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–µ–º–æ –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ...")
    
    try:
        response = requests.post(
            "http://72.56.66.228/api/trends/collect-reels",
            json={"competitors": ["rem.vac"], "count": 3},
            headers={'Content-Type': 'application/json'},
            timeout=30
        )
        
        if response.status_code == 200:
            data = response.json()
            if data.get('success') and data.get('reels'):
                first_reel = data['reels'][0]
                caption = first_reel.get('caption', '')
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏–∑–Ω–∞–∫–∏ –¥–µ–º–æ –¥–∞–Ω–Ω—ã—Ö
                demo_indicators = ['–¥–µ–º–æ', 'demo', '–ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞', '21.01.1970']
                has_demo = any(indicator in caption.lower() for indicator in demo_indicators)
                
                if has_demo:
                    print("‚ùå –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û: –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–µ–º–æ –¥–∞–Ω–Ω—ã–µ!")
                    print(f"   –ü—Ä–∏–º–µ—Ä: {caption[:100]}...")
                    return True
                else:
                    print("‚úÖ –û–¢–õ–ò–ß–ù–û: –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ!")
                    return False
            else:
                print("‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã—Ö")
                return None
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞ API: {response.status_code}")
            return None
            
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {e}")
        return None

def show_manual_update_instructions():
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"""
    print("\n" + "="*60)
    print("üö® –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ï–†–í–ï–†–ê")
    print("="*60)
    print()
    print("‚ùå –ü–†–û–ë–õ–ï–ú–ê: –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–µ–º–æ –¥–∞–Ω–Ω—ã–µ!")
    print("üéØ –†–ï–®–ï–ù–ò–ï: –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä")
    print()
    print("üöÄ –ù–ï–ú–ï–î–õ–ï–ù–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø:")
    print("1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É: ssh root@72.56.66.228")
    print("2. –ù–∞–π–¥–∏—Ç–µ –ø–∞–ø–∫—É —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º")
    print("3. –°–¥–µ–ª–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é: cp app.py app_backup.py")
    print("4. –ó–∞–º–µ–Ω–∏—Ç–µ app.py –Ω–∞ app_for_server_final.py")
    print("5. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ: pkill -f python && python3 app.py")
    print()
    print("üìÅ –§–ê–ô–õ–´ –î–õ–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø:")
    print("‚úÖ app_for_server_final.py - –í–ï–†–°–ò–Ø –ë–ï–ó –î–ï–ú–û –î–ê–ù–ù–´–•")
    print("‚úÖ URGENT_SERVER_UPDATE.md - –°—Ä–æ—á–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è")
    print("‚úÖ verify_server_fix.py - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")
    print()
    print("üîç –°–ü–û–°–û–ë–´ –ó–ê–ì–†–£–ó–ö–ò –§–ê–ô–õ–ê:")
    print("1. SCP: scp app_for_server_final.py root@72.56.66.228:/path/to/app.py")
    print("2. FTP/SFTP: –ó–∞–≥—Ä—É–∑–∏—Ç–µ —á–µ—Ä–µ–∑ FTP –∫–ª–∏–µ–Ω—Ç")
    print("3. –í–µ–±-–ø–∞–Ω–µ–ª—å: –ó–∞–≥—Ä—É–∑–∏—Ç–µ —á–µ—Ä–µ–∑ —Ñ–∞–π–ª–æ–≤—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä —Ö–æ—Å—Ç–∏–Ω–≥–∞")
    print("4. Git: git push (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Git)")
    print()
    print("‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û:")
    print("- –î–ï–ú–û –î–ê–ù–ù–´–ï –í –ü–†–û–î–ê–ö–®–ï–ù–ï –ù–ï–î–û–ü–£–°–¢–ò–ú–´!")
    print("- –û–±–Ω–æ–≤–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ!")
    print("- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")

def create_emergency_script():
    """–°–æ–∑–¥–∞–µ—Ç —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"""
    script_content = """#!/bin/bash
# –≠–ö–°–¢–†–ï–ù–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ï–†–í–ï–†–ê - –£–ë–ò–†–ê–ï–ú –î–ï–ú–û –î–ê–ù–ù–´–ï

echo "üö® –≠–ö–°–¢–†–ï–ù–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ï–†–í–ï–†–ê"
echo "================================"

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã (–∏–∑–º–µ–Ω–∏—Ç–µ –ø–æ–¥ –≤–∞—à–∏)
SERVER="72.56.66.228"
USER="root"
REMOTE_PATH="/root/gsr"  # –ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à –ø—É—Ç—å

echo "üì° –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É: $USER@$SERVER"
echo "üìÅ –ü—É—Ç—å –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é: $REMOTE_PATH"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª
if [ ! -f "app_for_server_final.py" ]; then
    echo "‚ùå –§–∞–π–ª app_for_server_final.py –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "üîß –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º –∫–æ–¥–æ–º"
    exit 1
fi

echo "‚úÖ –§–∞–π–ª app_for_server_final.py –Ω–∞–π–¥–µ–Ω"

# –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
echo "üíæ –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é..."
ssh $USER@$SERVER "cd $REMOTE_PATH && cp app.py app_backup_\$(date +%Y%m%d_%H%M%S).py"

# –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
echo "üì§ –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª..."
scp app_for_server_final.py $USER@$SERVER:$REMOTE_PATH/app.py

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
ssh $USER@$SERVER "cd $REMOTE_PATH && pkill -f python && python3 app.py &"

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
sleep 5

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç..."
python3 verify_server_fix.py

echo ""
echo "üéâ –û–ë–ù–û–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!"
echo "======================="
echo "‚úÖ –§–∞–π–ª –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–æ"
echo "‚úÖ –î–µ–º–æ –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–±—Ä–∞–Ω—ã"
echo ""
echo "üîç –ü–†–û–í–ï–†–ö–ê:"
echo "1. –û—Ç–∫—Ä–æ–π—Ç–µ http://72.56.66.228/module/trends"
echo "2. –ù–∞–∂–º–∏—Ç–µ '–°–æ–±—Ä–∞—Ç—å —Ä–∏–ª—Å—ã –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤'"
echo "3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–µ—Ç '–î–µ–º–æ-–ø–æ—Å—Ç' –∏ –¥–∞—Ç '21.01.1970'"
"""
    
    with open("emergency_update.sh", "w") as f:
        f.write(script_content)
    
    import os
    os.chmod("emergency_update.sh", 0o755)
    print("‚úÖ –°–æ–∑–¥–∞–Ω —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç emergency_update.sh")

def main():
    print("üö® –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ï–†–í–ï–†–ê")
    print("–£–±–∏—Ä–∞–µ–º –¥–µ–º–æ –¥–∞–Ω–Ω—ã–µ –∏–∑ –º–æ–¥—É–ª—è —Ç—Ä–µ–Ω–¥–æ–≤")
    print("="*50)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–µ–º–æ –¥–∞–Ω–Ω—ã–µ
    has_demo = check_demo_data()
    
    if has_demo is True:
        print("\n‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: –î–µ–º–æ –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ!")
        print("üéØ –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –¢–†–ï–ë–£–ï–¢–°–Ø!")
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
        show_manual_update_instructions()
        
        # –°–æ–∑–¥–∞–µ–º —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç
        create_emergency_script()
        
        print("\n" + "="*60)
        print("üöÄ –ì–û–¢–û–í–´–ï –ò–ù–°–¢–†–£–ú–ï–ù–¢–´:")
        print("‚úÖ emergency_update.sh - –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")
        print("‚úÖ app_for_server_final.py - –§–∞–π–ª –±–µ–∑ –¥–µ–º–æ –¥–∞–Ω–Ω—ã—Ö")
        print("‚úÖ verify_server_fix.py - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")
        print("‚úÖ URGENT_SERVER_UPDATE.md - –°—Ä–æ—á–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è")
        print()
        print("üéØ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò:")
        print("1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: ./emergency_update.sh")
        print("2. –ò–ª–∏ —Å–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –≤ URGENT_SERVER_UPDATE.md")
        print("3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç")
        
    elif has_demo is False:
        print("\n‚úÖ –û–¢–õ–ò–ß–ù–û: –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ —É–∂–µ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ!")
        print("üéâ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è")
        
    else:
        print("\n‚ö†Ô∏è –ù–ï –£–î–ê–õ–û–°–¨ –ü–†–û–í–ï–†–ò–¢–¨ –°–ï–†–í–ï–†")
        print("üîß –í–æ–∑–º–æ–∂–Ω–æ, —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å API")
        show_manual_update_instructions()

if __name__ == "__main__":
    main()
