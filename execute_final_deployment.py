#!/usr/bin/env python3
"""
–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
"""

import os
import shutil
import tarfile
from pathlib import Path
from datetime import datetime

def execute_final_deployment():
    """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è"""
    print("üöÄ –í–´–ü–û–õ–ù–ï–ù–ò–ï –§–ò–ù–ê–õ–¨–ù–û–ì–û –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Ø")
    print("=" * 60)
    print(f"‚è∞ –í—Ä–µ–º—è: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    
    # –°–æ–∑–¥–∞–µ–º –∏–º—è –∞—Ä—Ö–∏–≤–∞ —Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–æ–π
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    archive_name = f"gsr_final_deploy_{timestamp}.tar.gz"
    
    print(f"üìÅ –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤: {archive_name}")
    
    # –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∞—Ä—Ö–∏–≤–∞
    files_to_include = [
        'app_for_server_final.py',
        'config.py',
        'models.py',
        'requirements.txt',
        'run.py',
        'api/',
        'templates/',
        'static/',
        'modules/'
    ]
    
    # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    temp_dir = Path(f"temp_final_deploy_{timestamp}")
    temp_dir.mkdir(exist_ok=True)
    
    print("üìã –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã:")
    copied_files = 0
    
    for item in files_to_include:
        source = Path(item)
        if source.exists():
            if source.is_file():
                shutil.copy2(source, temp_dir / source.name)
                print(f"   ‚úÖ {item}")
                copied_files += 1
            else:
                shutil.copytree(source, temp_dir / source.name, dirs_exist_ok=True)
                print(f"   ‚úÖ {item}/")
                copied_files += 1
        else:
            print(f"   ‚ùå {item} - –ù–ï –ù–ê–ô–î–ï–ù")
    
    print(f"\nüìä –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ —Ñ–∞–π–ª–æ–≤/–ø–∞–ø–æ–∫: {copied_files}")
    
    # –°–æ–∑–¥–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
    instructions = f"""# üöÄ –§–ò–ù–ê–õ–¨–ù–´–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Æ –ù–ê –°–ï–†–í–ï–†–ï

## üì¶ –ê—Ä—Ö–∏–≤: {archive_name}
## ‚è∞ –°–æ–∑–¥–∞–Ω: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
## ‚úÖ –°—Ç–∞—Ç—É—Å: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é

### üîß –°–ü–û–°–û–ë 1: –ß–ï–†–ï–ó –í–ï–ë-–ü–ê–ù–ï–õ–¨ –•–û–°–¢–ò–ù–ì–ê

1. **–í–æ–π–¥–∏—Ç–µ –≤ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ö–æ—Å—Ç–∏–Ω–≥–æ–º**
   - –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª–æ–≤—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä
   - –ù–∞–π–¥–∏—Ç–µ –ø–∞–ø–∫—É —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º (–æ–±—ã—á–Ω–æ `/var/www/gsr/` –∏–ª–∏ `/public_html/`)

2. **–°–æ–∑–¥–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é**
   - –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–µ–∫—É—â–∏–π `app.py` –≤ `app_backup.py`
   - –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ç–µ–∫—É—â—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

3. **–ó–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–æ–≤—ã–π –∞—Ä—Ö–∏–≤**
   - –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª `{archive_name}`
   - –†–∞—Å–ø–∞–∫—É–π—Ç–µ –µ–≥–æ –≤ –ø–∞–ø–∫—É —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º

4. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ**
   - –ü–µ—Ä–µ–∏–º–µ–Ω—É–π—Ç–µ `app_for_server_final.py` –≤ `app.py`
   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞: `chmod +x app.py`

5. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**
   - –û—Ç–∫—Ä–æ–π—Ç–µ —Ç–µ—Ä–º–∏–Ω–∞–ª –≤ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
   - –í—ã–ø–æ–ª–Ω–∏—Ç–µ: `pip3 install -r requirements.txt`

6. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ**
   - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–µ–∫—É—â–µ–µ: `pkill -f 'python.*app.py'`
   - –ó–∞–ø—É—Å—Ç–∏—Ç–µ –Ω–æ–≤–æ–µ: `nohup python3 app.py > app.log 2>&1 &`

### üîß –°–ü–û–°–û–ë 2: –ß–ï–†–ï–ó SSH (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)

```bash
# 1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞—Ä—Ö–∏–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
scp {archive_name} user@72.56.66.228:/tmp/

# 2. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É
ssh user@72.56.66.228

# 3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ø–∞–ø–∫—É —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º
cd /var/www/gsr/

# 4. –°–æ–∑–¥–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
tar -czf backup_$(date +%Y%m%d_%H%M%S).tar.gz *.py *.html *.css *.js

# 5. –†–∞—Å–ø–∞–∫—É–π—Ç–µ –Ω–æ–≤—ã–π –∞—Ä—Ö–∏–≤
tar -xzf /tmp/{archive_name} --strip-components=1

# 6. –ü–µ—Ä–µ–∏–º–µ–Ω—É–π—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª
mv app_for_server_final.py app.py

# 7. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
pip3 install -r requirements.txt

# 8. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
pkill -f 'python.*app.py'
nohup python3 app.py > app.log 2>&1 &
```

### ‚úÖ –ü–†–û–í–ï–†–ö–ê –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Ø

1. **–û—Ç–∫—Ä–æ–π—Ç–µ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É**
   - http://72.56.66.228/
   - –î–æ–ª–∂–Ω–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–æ–¥—É–ª–∏**
   - http://72.56.66.228/module/trends
   - http://72.56.66.228/module/vacancies
   - http://72.56.66.228/module/experts

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–µ–º–æ –¥–∞–Ω–Ω—ã—Ö**
   - –í –º–æ–¥—É–ª–µ —Ç—Ä–µ–Ω–¥–æ–≤ –Ω–∞–∂–º–∏—Ç–µ "–°–æ–±—Ä–∞—Ç—å —Ä–∏–ª—Å—ã"
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ù–ï–¢ —Ç–µ–∫—Å—Ç–∞ "–¥–µ–º–æ" –∏–ª–∏ "–ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞"

### üîß –£–°–¢–†–ê–ù–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú

**–ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
tail -f app.log

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–æ—Ä—Ç —Å–≤–æ–±–æ–¥–µ–Ω
netstat -tlnp | grep :5000

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
ls -la app.py
chmod +x app.py
```

**–ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ –∏–º–ø–æ—Ä—Ç–∞:**
```bash
# –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
pip3 install -r requirements.txt --force-reinstall

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Python –≤–µ—Ä—Å–∏—é
python3 --version
```

**–ï—Å–ª–∏ –¥–µ–º–æ –¥–∞–Ω–Ω—ã–µ –≤—Å–µ –µ—â–µ –µ—Å—Ç—å:**
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–º–µ–Ω–∏–ª–∏ `app.py` –Ω–∞ `app_for_server_final.py`
- –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- –û—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞

### üìû –ü–û–î–î–ï–†–ñ–ö–ê

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `tail -f app.log`
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —Ñ–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º
4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ—Ä—Ç 5000 —Å–≤–æ–±–æ–¥–µ–Ω

---
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
**–ê—Ä—Ö–∏–≤:** {archive_name}
**–°—Ç–∞—Ç—É—Å:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é ‚úÖ
"""
    
    with open(temp_dir / "FINAL_DEPLOY_INSTRUCTIONS.md", 'w', encoding='utf-8') as f:
        f.write(instructions)
    
    print("   ‚úÖ –°–æ–∑–¥–∞–Ω—ã –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏: FINAL_DEPLOY_INSTRUCTIONS.md")
    
    # –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤
    print(f"\nüì¶ –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ {archive_name}...")
    with tarfile.open(archive_name, "w:gz") as tar:
        tar.add(temp_dir, arcname="gsr_final_deploy")
    
    # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    shutil.rmtree(temp_dir)
    
    print(f"‚úÖ –ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω: {archive_name}")
    print(f"üìè –†–∞–∑–º–µ—Ä –∞—Ä—Ö–∏–≤–∞: {os.path.getsize(archive_name) / 1024 / 1024:.2f} MB")
    
    # –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∑–∫–∏
    script_name = f"upload_final_{archive_name.replace('.tar.gz', '')}.sh"
    
    script_content = f"""#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ {archive_name} –Ω–∞ —Å–µ—Ä–≤–µ—Ä 72.56.66.228

echo "üöÄ –§–ò–ù–ê–õ–¨–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –ù–ê –°–ï–†–í–ï–† 72.56.66.228"
echo "=========================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞—Ä—Ö–∏–≤–∞
if [ ! -f "{archive_name}" ]; then
    echo "‚ùå –ê—Ä—Ö–∏–≤ {archive_name} –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

echo "üì¶ –ê—Ä—Ö–∏–≤ –Ω–∞–π–¥–µ–Ω: {archive_name}"

# –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
echo "üíæ –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
ssh root@72.56.66.228 "cd /var/www/gsr && tar -czf backup_$(date +%Y%m%d_%H%M%S).tar.gz *.py *.html *.css *.js 2>/dev/null || true"

# –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—Ä—Ö–∏–≤
echo "üì§ –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—Ä—Ö–∏–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
scp {archive_name} root@72.56.66.228:/tmp/

# –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
echo "üìÅ –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
ssh root@72.56.66.228 "cd /var/www/gsr && tar -xzf /tmp/{archive_name} --strip-components=1"

# –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª
echo "üîÑ –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º app_for_server_final.py –≤ app.py..."
ssh root@72.56.66.228 "cd /var/www/gsr && mv app_for_server_final.py app.py"

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
ssh root@72.56.66.228 "cd /var/www/gsr && pip3 install -r requirements.txt"

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
ssh root@72.56.66.228 "cd /var/www/gsr && pkill -f 'python.*app.py' || true"
ssh root@72.56.66.228 "cd /var/www/gsr && nohup python3 app.py > app.log 2>&1 &"

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
sleep 5

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å..."
ssh root@72.56.66.228 "cd /var/www/gsr && ps aux | grep 'python.*app.py' | grep -v grep"

echo "‚úÖ –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "üåê –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: http://72.56.66.228/"
"""
    
    with open(script_name, 'w', encoding='utf-8') as f:
        f.write(script_content)
    
    # –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
    os.chmod(script_name, 0o755)
    
    print(f"‚úÖ –°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω: {script_name}")
    
    print("\n" + "=" * 60)
    print("üìä –ò–¢–û–ì–û–í–´–ô –°–¢–ê–¢–£–°")
    print("=" * 60)
    
    print("üéâ –§–ò–ù–ê–õ–¨–ù–´–ô –ü–ê–ö–ï–¢ –î–õ–Ø –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Ø –ì–û–¢–û–í!")
    print(f"üì¶ –ê—Ä—Ö–∏–≤: {archive_name}")
    print(f"üì§ –°–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∑–∫–∏: {script_name}")
    print(f"üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏: FINAL_DEPLOY_INSTRUCTIONS.md")
    
    print("\nüìû –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò:")
    print("1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ä–≤–µ—Ä: python3 perform_server_check.py")
    print("2. –†–∞–∑–≤–µ—Ä–Ω–∏—Ç–µ –ø–∞–∫–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ")
    print("3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Ä–∞–±–æ—Ç—É")
    
    print(f"\nüîß –î–õ–Ø –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ì–û –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Ø:")
    print(f"   ./{script_name}")
    
    print(f"\nüîß –î–õ–Ø –†–£–ß–ù–û–ì–û –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Ø:")
    print(f"   –°–º–æ—Ç—Ä–∏—Ç–µ FINAL_DEPLOY_INSTRUCTIONS.md")
    
    return archive_name, script_name

if __name__ == "__main__":
    execute_final_deployment()
