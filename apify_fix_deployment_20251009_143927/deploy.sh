#!/bin/bash
# ะกะบัะธะฟั ัะฐะทะฒะตัััะฒะฐะฝะธั ะธัะฟัะฐะฒะปะตะฝะธั Apify

echo "๐ ะะฐะทะฒะตัััะฒะฐะฝะธะต ะธัะฟัะฐะฒะปะตะฝะธั Apify ะฝะฐ ัะตัะฒะตัะต"
echo "=============================================="

# ะัะพะฒะตััะตะผ ะฟะพะดะบะปััะตะฝะธะต ะบ ัะตัะฒะตัั
echo "1. ะัะพะฒะตัะบะฐ ะฟะพะดะบะปััะตะฝะธั ะบ ัะตัะฒะตัั..."
if ! ssh -i server_key root@72.56.66.228 "echo 'ะะพะดะบะปััะตะฝะธะต ััะฟะตัะฝะพ'"; then
    echo "โ ะัะธะฑะบะฐ ะฟะพะดะบะปััะตะฝะธั ะบ ัะตัะฒะตัั"
    exit 1
fi

# ะกะพะทะดะฐะตะผ backup ัะตะบััะตะณะพ ัะฐะนะปะฐ
echo "2. ะกะพะทะดะฐะฝะธะต backup ัะตะบััะตะณะพ ัะฐะนะปะฐ..."
ssh -i server_key root@72.56.66.228 "
    if [ -f /root/gsr/api/apify_client.py ]; then
        cp /root/gsr/api/apify_client.py /root/gsr/api/apify_client_backup_$(date +%Y%m%d_%H%M%S).py
        echo 'โ Backup ัะพะทะดะฐะฝ'
    else
        echo 'โ๏ธ ะััะพะดะฝัะน ัะฐะนะป ะฝะต ะฝะฐะนะดะตะฝ'
    fi
"

# ะะฐะณััะถะฐะตะผ ะธัะฟัะฐะฒะปะตะฝะฝัะน ัะฐะนะป
echo "3. ะะฐะณััะทะบะฐ ะธัะฟัะฐะฒะปะตะฝะฝะพะณะพ ัะฐะนะปะฐ..."
scp -i server_key apify_client.py root@72.56.66.228:/root/gsr/api/apify_client.py

if [ $? -eq 0 ]; then
    echo "โ ะคะฐะนะป ะทะฐะณััะถะตะฝ ััะฟะตัะฝะพ"
else
    echo "โ ะัะธะฑะบะฐ ะทะฐะณััะทะบะธ ัะฐะนะปะฐ"
    exit 1
fi

# ะัะพะฒะตััะตะผ ะฟัะฐะฒะฐ ะดะพัััะฟะฐ
echo "4. ะัะพะฒะตัะบะฐ ะฟัะฐะฒ ะดะพัััะฟะฐ..."
ssh -i server_key root@72.56.66.228 "
    chmod 644 /root/gsr/api/apify_client.py
    echo 'โ ะัะฐะฒะฐ ะดะพัััะฟะฐ ัััะฐะฝะพะฒะปะตะฝั'
"

# ะะตัะตะทะฐะฟััะบะฐะตะผ ะฟัะธะปะพะถะตะฝะธะต
echo "5. ะะตัะตะทะฐะฟััะบ ะฟัะธะปะพะถะตะฝะธั..."
ssh -i server_key root@72.56.66.228 "
    cd /root/gsr
    pkill -f 'python.*app_current_backup.py' || true
    sleep 2
    nohup python3 app_current_backup.py > app.log 2>&1 &
    sleep 3
    echo 'โ ะัะธะปะพะถะตะฝะธะต ะฟะตัะตะทะฐะฟััะตะฝะพ'
"

# ะัะพะฒะตััะตะผ ััะฐััั
echo "6. ะัะพะฒะตัะบะฐ ััะฐัััะฐ ะฟัะธะปะพะถะตะฝะธั..."
ssh -i server_key root@72.56.66.228 "
    if pgrep -f 'python.*app_current_backup.py' > /dev/null; then
        echo 'โ ะัะธะปะพะถะตะฝะธะต ะทะฐะฟััะตะฝะพ'
    else
        echo 'โ ะัะธะปะพะถะตะฝะธะต ะฝะต ะทะฐะฟััะตะฝะพ'
        exit 1
    fi
"

echo "๐ ะะฐะทะฒะตัััะฒะฐะฝะธะต ะทะฐะฒะตััะตะฝะพ ััะฟะตัะฝะพ!"
echo "๐ ะัะพะฒะตัััะต: http://72.56.66.228/module/trends"
