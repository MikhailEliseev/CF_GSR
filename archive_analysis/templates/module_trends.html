{% extends "base.html" %}

{% block title %}–ú–æ–¥—É–ª—å –¢—Ä–µ–Ω–¥–≤–æ—Ç—á–∏–Ω–≥–∞ - –ö–æ–Ω—Ç–µ–Ω—Ç –ó–∞–≤–æ–¥{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card-gsr">
            <div class="card-body text-center gsr-bg-gradient text-white" style="border-radius: 16px 16px 0 0;">
                <img src="/static/7411193.png" alt="GSR" class="gsr-logo mb-3">
                <h1 class="gsr-heading mb-2">
                    <i class="fas fa-chart-line me-2"></i>–ú–æ–¥—É–ª—å –¢—Ä–µ–Ω–¥–≤–æ—Ç—á–∏–Ω–≥–∞
                </h1>
                <p class="mb-0 fs-5">–ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–æ–≤ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—É—Å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤</p>
                <a href="{{ url_for('settings_page', module_name='trends') }}" class="btn btn-outline-light btn-lg mt-3">
                    <i class="fas fa-cog me-2"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ API
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card-gsr progress-step module-status-card" id="statusInfo">
            <div class="row g-3 align-items-center">
                <div class="col-md-6">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-key text-success me-2"></i>
                        <div>
                            <div class="fw-semibold text-muted">Apify –∫–ª—é—á</div>
                            <div id="apifyStatus" class="fw-bold">–ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è‚Ä¶</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-users text-primary me-2"></i>
                        <div>
                            <div class="fw-semibold text-muted">–í—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã</div>
                            <div class="fw-bold"><span id="competitorsCount">0</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card-gsr progress-step step-active" id="step1">
            <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between mb-4">
                <div class="d-flex align-items-center mb-3 mb-md-0">
                    <div class="step-number-gsr">1</div>
                    <div>
                        <h4 class="gsr-heading mb-1 gsr-text-primary">–°–±–æ—Ä —Ä–∏–ª—Å–æ–≤</h4>
                        <p class="text-muted mb-0">–£–∫–∞–∂–∏—Ç–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –∏ –ª–∏–º–∏—Ç, —á—Ç–æ–±—ã —Å–æ–±—Ä–∞—Ç—å —Å–≤–µ–∂–∏–µ —Ä–∏–ª—Å—ã</p>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-lg-4">
                    <label class="form-label fw-semibold gsr-text-secondary">
                        <i class="fas fa-hashtag me-2"></i>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∏–ª—Å–æ–≤ –Ω–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞
                    </label>
                    <select class="form-select form-select-lg" id="reelsCount">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="30">30</option>
                        <option value="50">50</option>
                    </select>
                    <small class="text-muted">–ú–æ–∂–Ω–æ –æ—Ç–º–µ—Ç–∏—Ç—å —Å—Ä–∞–∑—É –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.</small>
                </div>
                <div class="col-lg-8">
                    <label class="form-label fw-semibold gsr-text-secondary">
                        <i class="fas fa-users me-2"></i>–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
                    </label>
                    <div id="competitorsList" class="p-3 border rounded bg-light" style="max-height: 220px; overflow-y: auto;">
                        <div class="text-center text-muted">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            <div class="mt-2">–ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤‚Ä¶</div>
                        </div>
                    </div>
                    <div class="form-text mt-2">
                        <a href="{{ url_for('settings_page', module_name='trends') }}" class="link-success">–ü–µ—Ä–µ–π—Ç–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤</a>
                    </div>
                </div>
            </div>

            <div class="d-flex flex-column flex-md-row gap-3 mt-4">
                <button class="btn btn-gsr-accent btn-lg flex-fill" id="collectButton" onclick="collectReels(event)">
                    <i class="fas fa-cloud-download-alt me-2"></i>–°–æ–±—Ä–∞—Ç—å —Ä–∏–ª—Å—ã –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card-gsr progress-step step-disabled" id="step2">
            <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between mb-4">
                <div class="d-flex align-items-center mb-3 mb-md-0">
                    <div class="step-number-gsr">2</div>
                    <div>
                        <h4 class="gsr-heading mb-1 gsr-text-primary">–û—Ç–±–æ—Ä —Ä–∏–ª—Å–æ–≤</h4>
                        <p class="text-muted mb-0">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –∏ –≤—ã–±–∏—Ä–∞–π—Ç–µ –ª—É—á—à–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç</p>
                    </div>
                </div>
                <div class="bg-light rounded px-3 py-2 text-muted small">
                    <div><strong>–í—Å–µ–≥–æ:</strong> <span id="totalReels">0</span></div>
                    <div><strong>–í–∏—Ä–∞–ª—å–Ω—ã—Ö (&gt;30k):</strong> <span id="viralReels">0</span></div>
                </div>
            </div>

            <div class="d-flex flex-wrap gap-2 mb-3">
                <div class="btn-group">
                    <button class="btn btn-outline-secondary btn-sm" onclick="sortReels('views')">
                        <i class="fas fa-sort-amount-down me-1"></i>–ü–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞–º
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="sortReels('likes')">
                        <i class="fas fa-heart me-1"></i>–ü–æ –ª–∞–π–∫–∞–º
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="sortReels('date')">
                        <i class="fas fa-calendar-day me-1"></i>–ü–æ –¥–∞—Ç–µ
                    </button>
                </div>
                <div class="ms-auto">
                    <button class="btn btn-outline-primary btn-sm" onclick="exportReels()">
                        <i class="fas fa-file-export me-1"></i>–í—ã–≥—Ä—É–∑–∏—Ç—å CSV
                    </button>
                </div>
            </div>

            <div class="row" id="reelsList"></div>
            <div class="text-center text-muted" id="emptyState" style="display:block;">
                <i class="fas fa-search fa-2x mb-2"></i>
                <p class="mb-0">–†–∏–ª—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–∏—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –∏–ª–∏ —É–≤–µ–ª–∏—á—å—Ç–µ –ª–∏–º–∏—Ç.</p>
            </div>
        </div>
    </div>
</div>

<!-- –®–∞–≥ 3: –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è -->
<div class="row">
    <div class="col-12">
        <div class="card-gsr progress-step step-disabled" id="step3">
            <div class="d-flex align-items-center mb-4">
                <div class="step-number-gsr">3</div>
                <div>
                    <h4 class="gsr-heading mb-1 gsr-text-primary">–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è</h4>
                    <p class="text-muted mb-0">AssemblyAI –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∞—É–¥–∏–æ –≤ —Ç–µ–∫—Å—Ç</p>
                </div>
            </div>
            
            <div id="selectedReelInfo" class="mb-4" style="display: none;">
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ä–∏–ª—Å–µ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
            </div>
            
            <button class="btn btn-gsr-accent btn-lg" onclick="transcribeReel()" id="transcribeBtn">
                <i class="fas fa-microphone me-2"></i>–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞—Ç—å
            </button>
            
            <div id="transcriptionResult" class="mt-4" style="display: none;">
                <label class="form-label gsr-text-primary">
                    <i class="fas fa-file-text me-2"></i>–¢–µ–∫—Å—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
                </label>
                <textarea class="form-control text-editor" id="transcriptionText" rows="6" 
                          placeholder="–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç..."></textarea>
                <div class="form-text">
                    <i class="fas fa-info-circle gsr-text-accent me-1"></i>
                    –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ–∫—Å—Ç –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –µ–≥–æ
                </div>
            </div>
            
            <div id="transcriptionStatus"></div>
        </div>
    </div>
</div>

<!-- –®–∞–≥ 4: –ü–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ -->
<div class="row">
    <div class="col-12">
        <div class="card-gsr progress-step step-disabled" id="step4">
            <div class="d-flex align-items-center mb-4">
                <div class="step-number-gsr">4</div>
                <div>
                    <h4 class="gsr-heading mb-1 gsr-text-primary">–ü–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞</h4>
                    <p class="text-muted mb-0">OpenAI –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç –¥–ª—è –≤–∞—à–µ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏</p>
                </div>
            </div>
            
            <button class="btn btn-gsr-accent btn-lg" onclick="rewriteText()" id="rewriteBtn" disabled>
                <i class="fas fa-magic me-2"></i>–ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç
            </button>
            
            <div id="rewriteResult" class="mt-4" style="display: none;">
                <label class="form-label gsr-text-primary">
                    <i class="fas fa-edit me-2"></i>–ü–µ—Ä–µ–ø–∏—Å–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
                </label>
                <textarea class="form-control text-editor" id="rewrittenText" rows="6" 
                          placeholder="–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç..."></textarea>
                <div class="form-text">
                    <i class="fas fa-info-circle gsr-text-accent me-1"></i>
                    –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –∞—É–¥–∏–æ
                </div>
            </div>
            
            <div id="rewriteStatus"></div>
        </div>
    </div>
</div>

<!-- –®–∞–≥ 5: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—É–¥–∏–æ -->
<div class="row">
    <div class="col-12">
        <div class="card-gsr progress-step step-disabled" id="step5">
            <div class="d-flex align-items-center mb-4">
                <div class="step-number-gsr">5</div>
                <div>
                    <h4 class="gsr-heading mb-1 gsr-text-primary">–ê—É–¥–∏–æ–¥–æ—Ä–æ–∂–∫–∞</h4>
                    <p class="text-muted mb-0">ElevenLabs —Å–æ–∑–¥–∞–µ—Ç –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—É—é —Ä–µ—á—å</p>
                </div>
            </div>
            
            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞—É–¥–∏–æ -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <label class="form-label gsr-text-primary">
                        <i class="fas fa-robot me-2"></i>–ú–æ–¥–µ–ª—å ElevenLabs
                    </label>
                    <select class="form-select" id="audioModelId">
                        <option value="eleven_multilingual_v2">Eleven Multilingual v2 (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</option>
                        <option value="eleven_flash_v2_5">Eleven Flash v2.5 (–ë—ã—Å—Ç—Ä–∞—è)</option>
                        <option value="eleven_turbo_v2_5">Eleven Turbo v2.5 (–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label gsr-text-primary">
                        <i class="fas fa-microphone me-2"></i>–ì–æ–ª–æ—Å
                    </label>
                    <select class="form-select" id="audioVoiceId">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ–ª–æ—Å‚Ä¶</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label gsr-text-primary">
                        <i class="fas fa-file-text me-2"></i>–¢–µ–∫—Å—Ç –¥–ª—è –æ–∑–≤—É—á–∫–∏
                    </label>
                    <textarea class="form-control" id="audioText" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –æ–∑–≤—É—á–∫–∏..."></textarea>
                </div>
            </div>
            
            <button class="btn btn-gsr-accent btn-lg" onclick="generateAudio()" id="audioBtn" disabled>
                <i class="fas fa-microphone me-2"></i>–°–æ–∑–¥–∞—Ç—å –∞—É–¥–∏–æ
            </button>
            
            <div id="audioPlayer" class="mt-4"></div>
            <div id="audioStatus"></div>
        </div>
    </div>
</div>

<!-- –®–∞–≥ 6: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ -->
<div class="row">
    <div class="col-12">
        <div class="card-gsr progress-step step-disabled" id="step6">
            <div class="d-flex align-items-center mb-4">
                <div class="step-number-gsr">6</div>
                <div>
                    <h4 class="gsr-heading mb-1 gsr-text-primary">–ì–æ—Ç–æ–≤–æ–µ –≤–∏–¥–µ–æ</h4>
                    <p class="text-muted mb-0">HeyGen —Å–æ–∑–¥–∞–µ—Ç –≥–æ–≤–æ—Ä—è—â—É—é –≥–æ–ª–æ–≤—É</p>
                </div>
            </div>
            
            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–µ–æ -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <label class="form-label gsr-text-primary">
                        <i class="fas fa-user me-2"></i>–ê–≤–∞—Ç–∞—Ä
                    </label>
                    <select class="form-select" id="avatarSelect">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä‚Ä¶</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label gsr-text-primary">
                        <i class="fas fa-video me-2"></i>–§–æ—Ä–º–∞—Ç –≤–∏–¥–µ–æ
                    </label>
                    <select class="form-select" id="videoFormat">
                        <option value="vertical">–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ (9:16)</option>
                        <option value="horizontal">–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ (16:9)</option>
                        <option value="square">–ö–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ (1:1)</option>
                    </select>
                </div>
            </div>
            
            <button class="btn btn-gsr-accent btn-lg" onclick="generateFinalVideo()" id="videoBtn" disabled>
                <i class="fas fa-video me-2"></i>–°–æ–∑–¥–∞—Ç—å –≤–∏–¥–µ–æ
            </button>
            
            <div id="videoPlayer" class="mt-4"></div>
            <div id="videoStatus"></div>
        </div>
    </div>
</div>

<!-- –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç -->
<div class="card-gsr progress-step step-disabled d-none" id="finalResult">
    <div class="d-flex align-items-center mb-4">
        <div class="step-number-gsr">7</div>
        <div>
            <h4 class="gsr-heading mb-1 gsr-text-primary">–ì–æ—Ç–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</h4>
            <p class="text-muted mb-0">–°–∫–∞—á–∞–π—Ç–µ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</p>
        </div>
    </div>
    <div id="finalVideoResult"></div>
</div>

<!-- –°–∏—Å—Ç–µ–º–Ω—ã–π –ª–æ–≥ -->
<div class="card-gsr mt-4">
    <div class="card-body">
        <h6 class="mb-0"><i class="fas fa-terminal me-2"></i>–õ–æ–≥–∏ –¥–µ–π—Å—Ç–≤–∏–π</h6>
    </div>
    <div class="card-body" style="max-height: 200px; overflow-y: auto;" id="logArea">
        <div class="text-muted">–õ–æ–≥–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å‚Ä¶</div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let selectedReel = null;
let transcriptText = '';
let rewrittenText = '';
let lastLoadedReels = [];
let currentAudioUrl = '';
let currentVideoUrl = '';

function log(message, type = 'info') {
    const container = document.getElementById('logArea');
    const line = document.createElement('div');
    const time = new Date().toLocaleTimeString();
    const colors = { info: 'text-muted', success: 'text-success', error: 'text-danger' };
    line.className = colors[type] || 'text-muted';
    line.textContent = `[${time}] ${message}`;
    container.prepend(line);
}

document.addEventListener('DOMContentLoaded', async () => {
    await Promise.all([loadCompetitors(), loadVoicesAndAvatars(), checkApifyStatus()]);
});

async function checkApifyStatus() {
    try {
        const response = await fetch('/api/settings/trends');
        if (!response.ok) throw new Error('settings response not ok');
        const data = await response.json();
        const apifyKey = data?.api_keys?.apify_api_key;
        document.getElementById('apifyStatus').innerHTML = apifyKey ? `<span class="text-success">–Ω–∞–π–¥–µ–Ω</span>` : `<span class="text-danger">–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</span>`;
    } catch (err) {
        log(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å Apify –∫–ª—é—á: ${err.message}`, 'error');
        document.getElementById('apifyStatus').innerHTML = `<span class="text-danger">–æ—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏</span>`;
    }
}

async function loadCompetitors() {
    try {
        const response = await fetch('/api/competitors');
        const competitors = await response.json();
        const container = document.getElementById('competitorsList');

        if (!Array.isArray(competitors) || competitors.length === 0) {
            container.innerHTML = `<div class="text-center text-muted">–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã. <a href="/settings/trends">–ü–µ—Ä–µ–π—Ç–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</a></div>`;
            document.getElementById('competitorsCount').textContent = '0';
            return;
        }

        container.innerHTML = competitors.map((comp, index) => `
            <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" value="${comp.username}" id="comp_${comp.id}" ${index === 0 ? 'checked' : ''}>
                <label class="form-check-label" for="comp_${comp.id}">
                    <strong>@${comp.username}</strong>
                    <span class="text-muted">(${comp.platform})</span>
                </label>
            </div>
        `).join('');
        document.getElementById('competitorsCount').textContent = competitors.length;
    } catch (error) {
        log(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤: ${error.message}`, 'error');
    }
}

async function loadVoicesAndAvatars() {
    try {
        const [voicesResponse, avatarsResponse] = await Promise.all([
            fetch('/api/elevenlabs/voices'),
            fetch('/api/heygen/avatars')
        ]);

        const audioVoiceSelect = document.getElementById('audioVoiceId');
        const avatarSelect = document.getElementById('avatarSelect');

        if (voicesResponse.ok) {
            const voices = await voicesResponse.json();
            if (!voices.error && voices.voices) {
                voices.voices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.voice_id;
                    option.textContent = voice.name;
                    audioVoiceSelect.appendChild(option);
                });
            }
        }

        if (avatarsResponse.ok) {
            const avatars = await avatarsResponse.json();
            if (!avatars.error && avatars.avatars) {
                avatars.avatars.forEach(avatar => {
                    const option = document.createElement('option');
                    option.value = avatar.avatar_id;
                    option.textContent = avatar.avatar_name;
                    avatarSelect.appendChild(option);
                });
            }
        }
    } catch (error) {
        log(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ–ª–æ—Å–æ–≤/–∞–≤–∞—Ç–∞—Ä–æ–≤: ${error.message}`, 'error');
    }
}

async function collectReels(event) {
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>–°–æ–±–∏—Ä–∞—é‚Ä¶';

    try {
        const selectedCompetitors = Array.from(document.querySelectorAll('#competitorsList input:checked')).map(el => el.value);
        if (selectedCompetitors.length === 0) {
            window.alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞');
            return;
        }

        const reelsCount = parseInt(document.getElementById('reelsCount').value, 10);
        log(`–ó–∞–ø—Ä–æ—Å –∫ Apify: ${selectedCompetitors.join(', ')} (–ø–æ ${reelsCount})`);

        const response = await fetch('/api/trends/collect-reels?v=' + Date.now(), {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache'
            },
            body: JSON.stringify({
                competitors: selectedCompetitors,
                count: reelsCount
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            throw new Error(`–û–∂–∏–¥–∞–ª—Å—è JSON, –ø–æ–ª—É—á–µ–Ω: ${contentType}. –û—Ç–≤–µ—Ç: ${text.substring(0, 100)}...`);
        }
        
        const result = await response.json();

        if (!result.success) {
            log(`Apify –æ—Ç–≤–µ—Ç–∏–ª –æ—à–∏–±–∫–æ–π: ${result.message}`, 'error');
            window.alert(`–û—à–∏–±–∫–∞: ${result.message}`);
            return;
        }

        if (!result.reels || result.reels.length === 0) {
            log('Apify –≤–µ—Ä–Ω—É–ª 0 –ø–æ—Å—Ç–æ–≤', 'error');
            window.alert('Apify –Ω–µ –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á/–∞–∫–∫–∞—É–Ω—Ç—ã.');
            return;
        }

        lastLoadedReels = result.reels;
        GSRPipeline.enableStep('step2');
        GSRPipeline.activateStep('step2', { exclusive: true });
        displayReels(result.reels);
        document.getElementById('step2').scrollIntoView({ behavior: 'smooth' });
        log(`–ü–æ–ª—É—á–µ–Ω–æ ${result.reels.length} –ø–æ—Å—Ç–æ–≤. –í–∏—Ä–∞–ª—å–Ω—ã—Ö: ${result.viral_count}`, 'success');
    } catch (error) {
        log(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
        window.alert(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`);
    } finally {
        button.disabled = false;
        button.innerHTML = originalText;
    }
}

function displayReels(reels) {
    const container = document.getElementById('reelsList');
    const viralReels = reels.filter(r => r.is_viral || (r.views_count || 0) > 30000);

    document.getElementById('totalReels').textContent = reels.length;
    document.getElementById('viralReels').textContent = viralReels.length;
    document.getElementById('emptyState').style.display = reels.length === 0 ? 'block' : 'none';

    container.innerHTML = reels.map((reel, index) => {
        const caption = (reel.caption || '').slice(0, 140);
        const hashtags = (reel.hashtags || []).slice(0, 4).map(tag => `#${tag}`).join(' ');
        const firstComment = reel.first_comment ? reel.first_comment.slice(0, 80) : '';
        const music = reel.music ? `<div class="small text-muted"><i class="fas fa-music me-1"></i>${reel.music}</div>` : '';
        const thumbnail = reel.thumbnail_url ? `<img src="${reel.thumbnail_url}" class="img-fluid rounded mb-2" alt="preview">` : '';
        return `
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="card h-100 reel-card ${reel.is_viral || (reel.views_count || 0) > 30000 ? 'border-success' : 'border-secondary'}"
                 data-reel-id="${reel.id}" onclick="selectReel('${reel.id}', '${reel.video_url}', ${index})">
                <div class="card-body">
                    ${thumbnail}
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0">@${reel.source_username || 'unknown'}</h6>
                        <small class="text-muted">${reel.timestamp ? new Date(reel.timestamp).toLocaleDateString() : '-'}</small>
                    </div>
                    <p class="small">${caption || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</p>
                    ${hashtags ? `<div class="small text-muted mb-2">${hashtags}</div>` : ''}
                    ${firstComment ? `<div class="alert alert-light p-2 small border"><i class="far fa-comment-dots me-1"></i>${firstComment}</div>` : ''}
                    ${music}
                    <div class="row text-center mt-2">
                        <div class="col"><strong>${(reel.views_count || 0).toLocaleString()}</strong><div class="text-muted small">üëÅ –ü—Ä–æ—Å–º–æ—Ç—Ä—ã</div></div>
                        <div class="col"><strong>${(reel.likes_count || 0).toLocaleString()}</strong><div class="text-muted small">‚ù§Ô∏è –õ–∞–π–∫–∏</div></div>
                        <div class="col"><strong>${(reel.comments_count || 0).toLocaleString()}</strong><div class="text-muted small">üí¨ –ö–æ–º–º–µ–Ω—Ç—ã</div></div>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-top-0">
                    <div class="d-grid gap-2">
                        <a class="btn btn-outline-secondary btn-sm" href="${reel.url}" target="_blank" onclick="event.stopPropagation();">
                            <i class="fas fa-external-link-alt me-1"></i>–û—Ç–∫—Ä—ã—Ç—å –≤ Instagram
                        </a>
                        <button class="btn btn-outline-primary btn-sm" onclick="event.stopPropagation(); openVideoPreview('${reel.video_url}', '${(reel.source_username || '').replace(/'/g, "&apos;")}', '${(caption || '').replace(/'/g, "&apos;")}', ${index})">
                            <i class="fas fa-play me-1"></i>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                        </button>
                    </div>
                </div>
            </div>
        </div>`;
    }).join('');
}

function selectReel(reelId, videoUrl, index) {
    document.querySelectorAll('.reel-card').forEach(card => card.classList.remove('border-warning'));
    const card = document.querySelector(`[data-reel-id="${reelId}"]`);
    if (card) card.classList.add('border-warning');

    selectedReel = { id: reelId, video_url: videoUrl, index };
    const reelData = lastLoadedReels[index];

    document.getElementById('selectedReelInfo').innerHTML = `
        <div class="small text-muted">–ò—Å—Ç–æ—á–Ω–∏–∫: @${reelData?.source_username || 'unknown'}</div>
        <div class="fw-bold mb-2">${reelData?.caption || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
        <div class="d-flex justify-content-between">
            <span>üëÅ ${(reelData?.views_count || 0).toLocaleString()}</span>
            <span>‚ù§Ô∏è ${(reelData?.likes_count || 0).toLocaleString()}</span>
            <span>üí¨ ${(reelData?.comments_count || 0).toLocaleString()}</span>
        </div>
        <hr>
        <div class="small text-muted">ID: ${reelId}</div>
        <div class="small text-muted">–í–∏–¥–µ–æ: ${videoUrl ? '<a href="' + videoUrl + '" target="_blank">—Å—Å—ã–ª–∫–∞</a>' : '–Ω–µ—Ç –ø—Ä—è–º–æ–π —Å—Å—ã–ª–∫–∏'}</div>
    `;
    
    document.getElementById('selectedReelInfo').style.display = 'block';
    GSRPipeline.enableStep('step3');
    GSRPipeline.activateStep('step3', { exclusive: true });
    document.getElementById('step3').scrollIntoView({ behavior: 'smooth' });
}



function proceedToRewrite() {
    const modal = document.querySelector('.modal');
    if (modal) {
        const instance = bootstrap.Modal.getInstance(modal);
        if (instance) instance.hide();
    }
    const transcriptTextArea = document.getElementById('transcriptTextArea');
    if (transcriptTextArea) {
        transcriptText = transcriptTextArea.value;
        const transcriptField = document.getElementById('transcriptionText');
        if (transcriptField) transcriptField.value = transcriptText;
    }
    GSRPipeline.enableStep('step4');
    GSRPipeline.activateStep('step4', { exclusive: true });
    const step = document.getElementById('step4');
    if (step) step.scrollIntoView({ behavior: 'smooth' });
}





function proceedToAudio() {
    const modal = document.querySelector('.modal');
    if (modal) {
        const instance = bootstrap.Modal.getInstance(modal);
        if (instance) instance.hide();
    }
    const rewrittenTextArea = document.getElementById('rewrittenTextArea');
    if (rewrittenTextArea) {
        rewrittenText = rewrittenTextArea.value;
        const rewriteField = document.getElementById('rewrittenText');
        if (rewriteField) rewriteField.value = rewrittenText;
    }
    GSRPipeline.enableStep('step5');
    GSRPipeline.activateStep('step5', { exclusive: true });
    const step = document.getElementById('step5');
    if (step) step.scrollIntoView({ behavior: 'smooth' });
}









async function transcribeReel() {
    if (!selectedReel) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∏–ª—Å –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏');
        return;
    }

    GSRPipeline.showStatus('transcriptionStatus', 'processing', '–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...');
    
    try {
        const response = await fetch('/api/trends/transcribe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                reel_id: selectedReel.id,
                video_url: selectedReel.video_url 
            })
        });
        const result = await response.json();

        if (result.success) {
            transcriptText = result.transcript;
            document.getElementById('transcriptionText').value = transcriptText;
            document.getElementById('transcriptionResult').style.display = 'block';
            document.getElementById('rewriteBtn').disabled = false;
            GSRPipeline.enableStep('step4');
            GSRPipeline.activateStep('step4', { exclusive: true });
            GSRPipeline.showStatus('transcriptionStatus', 'completed', '‚úÖ –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
            log(`–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –¢–µ–∫—Å—Ç: ${transcriptText.substring(0, 50)}...`, 'success');
        } else {
            GSRPipeline.showStatus('transcriptionStatus', 'error', '‚ùå ' + result.message);
            log(`–û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏: ${result.message}`, 'error');
        }
    } catch (error) {
        GSRPipeline.showStatus('transcriptionStatus', 'error', '‚ùå ' + error.message);
        log(`–û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏: ${error.message}`, 'error');
    }
}

async function rewriteText() {
    if (!transcriptText) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—é');
        return;
    }

    GSRPipeline.showStatus('rewriteStatus', 'processing', '–ü–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞...');
    
    try {
        const response = await fetch('/api/trends/rewrite', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ transcript: transcriptText })
        });
        const result = await response.json();

        if (result.success) {
            rewrittenText = result.rewritten_text;
            document.getElementById('rewrittenText').value = rewrittenText;
            document.getElementById('rewriteResult').style.display = 'block';
            document.getElementById('audioBtn').disabled = false;
            GSRPipeline.enableStep('step5');
            GSRPipeline.activateStep('step5', { exclusive: true });
            GSRPipeline.showStatus('rewriteStatus', 'completed', '‚úÖ –¢–µ–∫—Å—Ç –ø–µ—Ä–µ–ø–∏—Å–∞–Ω!');
            log(`–ü–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç: ${rewrittenText.substring(0, 50)}...`, 'success');
        } else {
            GSRPipeline.showStatus('rewriteStatus', 'error', '‚ùå ' + result.message);
            log(`–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏—è: ${result.message}`, 'error');
        }
    } catch (error) {
        GSRPipeline.showStatus('rewriteStatus', 'error', '‚ùå ' + error.message);
        log(`–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏—è: ${error.message}`, 'error');
    }
}

async function generateAudio() {
    const voiceId = document.getElementById('audioVoiceId').value;
    const modelId = document.getElementById('audioModelId').value;
    const text = document.getElementById('audioText').value || rewrittenText;

    if (!voiceId) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ–ª–æ—Å');
        return;
    }

    if (!text.trim()) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –æ–∑–≤—É—á–∫–∏');
        return;
    }

    GSRPipeline.showStatus('audioStatus', 'processing', '–°–æ–∑–¥–∞–Ω–∏–µ –∞—É–¥–∏–æ...');
    
    try {
        const response = await fetch('/api/trends/generate-audio', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                text: text,
                voice_id: voiceId,
                model_id: modelId
            })
        });
        const result = await response.json();

        if (result.success) {
            currentAudioUrl = result.audio_url;
            document.getElementById('audioPlayer').innerHTML = `
                <div class="mb-3">
                    <audio controls class="audio-player w-100 mb-3" style="border-radius: 12px;">
                        <source src="${result.audio_url}" type="audio/mpeg">
                        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç.
                    </audio>
                    <div class="text-center">
                        <a href="${result.audio_url}" download class="btn btn-gsr-accent btn-sm">
                            <i class="fas fa-download me-2"></i>–°–∫–∞—á–∞—Ç—å –∞—É–¥–∏–æ
                        </a>
                    </div>
                </div>
            `;
            document.getElementById('videoBtn').disabled = false;
            GSRPipeline.enableStep('step6');
            GSRPipeline.activateStep('step6', { exclusive: true });
            GSRPipeline.showStatus('audioStatus', 'completed', '‚úÖ –ê—É–¥–∏–æ —Å–æ–∑–¥–∞–Ω–æ!');
            log(`–ê—É–¥–∏–æ —Å–æ–∑–¥–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ`, 'success');
        } else {
            GSRPipeline.showStatus('audioStatus', 'error', '‚ùå ' + result.message);
            log(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞—É–¥–∏–æ: ${result.message}`, 'error');
        }
    } catch (error) {
        GSRPipeline.showStatus('audioStatus', 'error', '‚ùå ' + error.message);
        log(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞—É–¥–∏–æ: ${error.message}`, 'error');
    }
}

async function generateFinalVideo() {
    const avatarId = document.getElementById('avatarSelect').value;
    const videoFormat = document.getElementById('videoFormat').value;
    const text = document.getElementById('rewrittenText').value || rewrittenText;

    if (!avatarId) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä');
        return;
    }

    if (!text.trim()) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –≤–∏–¥–µ–æ');
        return;
    }

    GSRPipeline.showStatus('videoStatus', 'processing', '–°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–¥–µ–æ...');
    
    try {
        const response = await fetch('/api/trends/generate-video', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                text: text,
                avatar_id: avatarId,
                video_format: videoFormat
            })
        });
        const result = await response.json();

        if (result.success && result.video_id) {
            // –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞
            checkTrendsVideoStatus(result.video_id);
        } else if (result.success && result.video_url) {
            // Fallback –¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ API
            document.getElementById('videoPlayer').innerHTML = `
                <video controls class="video-player" style="width: 100%; max-width: 500px;">
                    <source src="${result.video_url}" type="video/mp4">
                    –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç.
                </video>
                <div class="mt-2">
                    <a href="${result.video_url}" target="_blank" class="btn btn-gsr-accent">
                        <i class="fas fa-download me-2"></i>–°–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ
                    </a>
                </div>
            `;
            currentVideoUrl = result.video_url;
            renderFinalResult(result.video_url);
            GSRPipeline.showStatus('videoStatus', 'completed', '‚úÖ –í–∏–¥–µ–æ —Å–æ–∑–¥–∞–Ω–æ!');
            log(`–í–∏–¥–µ–æ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ`, 'success');
        } else {
            GSRPipeline.showStatus('videoStatus', 'error', '‚ùå ' + result.message);
            log(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–¥–µ–æ: ${result.message}`, 'error');
        }
    } catch (error) {
        GSRPipeline.showStatus('videoStatus', 'error', '‚ùå ' + error.message);
        log(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–¥–µ–æ: ${error.message}`, 'error');
    }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤–∏–¥–µ–æ –¥–ª—è —Ç—Ä–µ–Ω–¥–æ–≤

function renderFinalResult(videoUrl) {
    const finalCard = document.getElementById('finalResult');
    if (finalCard) {
        finalCard.classList.remove('d-none');
        GSRPipeline.enableStep('finalResult');
        GSRPipeline.activateStep('finalResult', { exclusive: true });
    }
    const container = document.getElementById('finalVideoResult');
    if (!container) return;

    const safeText = (rewrittenText || transcriptText || '')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/
/g, '<br>');

    const audioSection = currentAudioUrl
        ? `<a href="${currentAudioUrl}" class="btn btn-outline-primary" target="_blank">
                <i class="fas fa-volume-up me-2"></i>–°–∫–∞—á–∞—Ç—å –∞—É–¥–∏–æ
           </a>`
        : '';

    container.innerHTML = `
        <div class="row g-4 align-items-start">
            <div class="col-lg-6">
                <video controls class="video-player" style="width: 100%; max-height: 400px;">
                    <source src="${videoUrl}" type="video/mp4">
                    –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç.
                </video>
            </div>
            <div class="col-lg-6">
                <div class="mb-3">
                    <h6 class="fw-bold text-muted">–ü–µ—Ä–µ–ø–∏—Å–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç</h6>
                    <div class="p-3 border rounded bg-light" style="max-height: 280px; overflow-y: auto;">${safeText}</div>
                </div>
                <div class="d-grid gap-2">
                    ${audioSection}
                    <a href="${videoUrl}" class="btn btn-gsr-accent" target="_blank">
                        <i class="fas fa-download me-2"></i>–°–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ
                    </a>
                </div>
            </div>
        </div>`;
}

async function checkTrendsVideoStatus(videoId) {
    const maxAttempts = 30; // 5 –º–∏–Ω—É—Ç —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º 10 —Å–µ–∫—É–Ω–¥
    let attempts = 0;
    
    const checkStatus = async () => {
        try {
            const response = await fetch('/api/trends/check-video-status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ video_id: videoId })
            });
            
            const result = await response.json();
            
            if (result.status === 'completed' && result.video_url) {
                // –í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ!
                document.getElementById('videoPlayer').innerHTML = `
                    <video controls class="video-player" style="width: 100%; max-width: 500px;">
                        <source src="${result.video_url}" type="video/mp4">
                        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç.
                    </video>
                    <div class="mt-2">
                        <a href="${result.video_url}" target="_blank" class="btn btn-gsr-accent">
                            <i class="fas fa-download me-2"></i>–°–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ
                        </a>
                    </div>
                `;
                currentVideoUrl = result.video_url;
                renderFinalResult(result.video_url);
                GSRPipeline.showStatus('videoStatus', 'completed', '‚úÖ –í–∏–¥–µ–æ —Å–æ–∑–¥–∞–Ω–æ!');
                log('–í–∏–¥–µ–æ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ', 'success');
            } else if (result.status === 'failed') {
                GSRPipeline.showStatus('videoStatus', 'error', '‚ùå ' + (result.error_message || '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ –Ω–µ —É–¥–∞–ª–∞—Å—å'));
                log(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–¥–µ–æ: ${result.error_message}`, 'error');
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                const progress = Math.min(attempts * 3.33, 95); // 0-95%
                GSRPipeline.showStatus('videoStatus', 'processing', `–°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–¥–µ–æ... ${progress.toFixed(0)}% (${attempts * 10}—Å)`);
                
                attempts++;
                if (attempts < maxAttempts) {
                    setTimeout(checkStatus, 10000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
                } else {
                    GSRPipeline.showStatus('videoStatus', 'error', '‚ùå –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ');
                    log(`–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ`, 'error');
                }
            }
        } catch (error) {
            GSRPipeline.showStatus('videoStatus', 'error', '‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            log(`–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞: ${error.message}`, 'error');
        }
    };
    
    checkStatus();
}




function sortReels(criteria) {
    // –õ–æ–≥–∏–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Ä–∏–ª—Å–æ–≤
    console.log('Sorting by:', criteria);
}

// –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º–æ–≥–æ —Ä–∏–ª—Å–∞
let currentPreviewReel = null;

function openVideoPreview(videoUrl, username, caption, index) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ —Ä–∏–ª—Å–∞
    currentPreviewReel = {
        videoUrl: videoUrl,
        username: username,
        caption: caption,
        index: index,
        reelData: lastLoadedReels ? lastLoadedReels[index] : null
    };
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–∞–Ω–Ω—ã–º–∏
    document.getElementById('previewAuthor').textContent = `@${username}`;
    document.getElementById('previewCaption').textContent = caption;
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    const reelData = currentPreviewReel.reelData;
    if (reelData) {
        document.getElementById('previewViews').textContent = (reelData.views_count || 0).toLocaleString();
        document.getElementById('previewLikes').textContent = (reelData.likes_count || 0).toLocaleString();
        document.getElementById('previewComments').textContent = (reelData.comments_count || 0).toLocaleString();
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑—á–∏–∫
    document.getElementById('videoLoader').classList.remove('d-none');
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –≤–∏–¥–µ–æ
    const video = document.getElementById('previewVideo');
    const source = document.getElementById('previewVideoSource');
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ
    video.addEventListener('loadstart', function() {
        document.getElementById('videoLoader').classList.remove('d-none');
    });
    
    video.addEventListener('canplay', function() {
        document.getElementById('videoLoader').classList.add('d-none');
    });
    
    video.addEventListener('error', function() {
        document.getElementById('videoLoader').classList.add('d-none');
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É –≤–º–µ—Å—Ç–æ –≤–∏–¥–µ–æ
        video.poster = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPtCS0LjQtNC10L4g0L3QtSDQtNC+0YHRgtGD0L/QvdC+PC90ZXh0Pjwvc3ZnPg==';
    });
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º URL –≤–∏–¥–µ–æ
    if (videoUrl && videoUrl.includes('http')) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –ø—Ä—è–º–æ–π —Å—Å—ã–ª–∫–æ–π –Ω–∞ –≤–∏–¥–µ–æ
        if (videoUrl.includes('.mp4') || videoUrl.includes('.mov') || videoUrl.includes('.webm')) {
            source.src = videoUrl;
            console.log('Loading video:', videoUrl);
        } else {
            // –≠—Ç–æ —Å—Å—ã–ª–∫–∞ –Ω–∞ Instagram –ø–æ—Å—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
            console.log('Instagram post URL, showing placeholder');
            source.src = 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerBlazes.mp4';
        }
    } else {
        // –ï—Å–ª–∏ –Ω–µ—Ç URL, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É
        source.src = 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerBlazes.mp4';
        console.log('Using fallback video');
    }
    
    video.load(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ —Å –Ω–æ–≤—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º
    
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = new bootstrap.Modal(document.getElementById('videoPreviewModal'));
    modal.show();
}

function selectReelFromPreview() {
    if (currentPreviewReel && currentPreviewReel.reelData) {
        const reelData = currentPreviewReel.reelData;
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const modal = bootstrap.Modal.getInstance(document.getElementById('videoPreviewModal'));
        modal.hide();
        
        // –í—ã–±–∏—Ä–∞–µ–º —Ä–∏–ª—Å —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é
        selectReel(reelData.id, reelData.video_url, currentPreviewReel.index);
    }
}

function openInstagramPost() {
    if (currentPreviewReel && currentPreviewReel.reelData) {
        const reelData = currentPreviewReel.reelData;
        const instagramUrl = reelData.url || reelData.video_url;
        
        if (instagramUrl && instagramUrl.includes('instagram.com')) {
            window.open(instagramUrl, '_blank');
        } else {
            alert('–°—Å—ã–ª–∫–∞ –Ω–∞ Instagram –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
        }
    }
}

// –û—á–∏—Å—Ç–∫–∞ –≤–∏–¥–µ–æ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
document.getElementById('videoPreviewModal').addEventListener('hidden.bs.modal', function () {
    const video = document.getElementById('previewVideo');
    video.pause();
    video.currentTime = 0;
    currentPreviewReel = null;
});

</script>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤–∏–¥–µ–æ -->
<div class="modal fade" id="videoPreviewModal" tabindex="-1" aria-labelledby="videoPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="videoPreviewModalLabel">
                    <i class="fas fa-play-circle me-2"></i>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ä–∏–ª—Å–∞
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-4">
                <div class="mb-3">
                    <h6 id="previewAuthor" class="text-primary"></h6>
                    <p id="previewCaption" class="text-muted small"></p>
                </div>
                
                <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–∏–¥–µ–æ -->
                <div class="video-container mb-3" style="position: relative; max-width: 400px; margin: 0 auto;">
                    <video id="previewVideo" 
                           controls 
                           style="width: 100%; height: auto; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);"
                           poster="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPtCS0LjQtNC10L4g0LTQu9GPINC/0YDQtdC00L/RgNC+0YHQvNC+0YLRgNCwPC90ZXh0Pjwvc3ZnPg==">
                        <source id="previewVideoSource" src="" type="video/mp4">
                        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤–∏–¥–µ–æ.
                    </video>
                    
                    <!-- –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä -->
                    <div id="videoLoader" class="position-absolute top-50 start-50 translate-middle d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                    </div>
                </div>
                
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∏–¥–µ–æ -->
                <div class="row text-center">
                    <div class="col-4">
                        <div class="p-2 bg-light rounded">
                            <i class="fas fa-eye text-primary"></i>
                            <div id="previewViews" class="fw-bold">-</div>
                            <small class="text-muted">–ü—Ä–æ—Å–º–æ—Ç—Ä—ã</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-2 bg-light rounded">
                            <i class="fas fa-heart text-danger"></i>
                            <div id="previewLikes" class="fw-bold">-</div>
                            <small class="text-muted">–õ–∞–π–∫–∏</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-2 bg-light rounded">
                            <i class="fas fa-comment text-info"></i>
                            <div id="previewComments" class="fw-bold">-</div>
                            <small class="text-muted">–ö–æ–º–º–µ–Ω—Ç—ã</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" onclick="openInstagramPost()">
                    <i class="fas fa-external-link-alt me-2"></i>–û—Ç–∫—Ä—ã—Ç—å –≤ Instagram
                </button>
                <button type="button" class="btn btn-success" onclick="selectReelFromPreview()">
                    <i class="fas fa-check me-2"></i>–í—ã–±—Ä–∞—Ç—å —ç—Ç–æ—Ç —Ä–∏–ª—Å
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>–ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
