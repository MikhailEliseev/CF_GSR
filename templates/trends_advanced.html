<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Модуль Трендвотчинга - Продвинутая версия</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .progress-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .step-card {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        .step-card.active {
            border-color: #007bff;
            background: #f8f9ff;
        }
        .step-card.completed {
            border-color: #28a745;
            background: #f8fff9;
        }
        .step-card.failed {
            border-color: #dc3545;
            background: #fff8f8;
        }
        .competitor-table {
            max-height: 400px;
            overflow-y: auto;
        }
        .text-editor {
            min-height: 200px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            padding: 10px;
        }
        .audio-player {
            width: 100%;
            margin: 10px 0;
        }
        .video-preview {
            width: 100%;
            max-width: 500px;
            border-radius: 10px;
        }
        .status-badge {
            font-size: 0.8em;
            padding: 4px 8px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Боковая панель -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> Прогресс анализа</h5>
                    </div>
                    <div class="card-body">
                        <div class="progress mb-3">
                            <div class="progress-bar" role="progressbar" style="width: 0%" id="overall-progress"></div>
                        </div>
                        <div id="progress-steps">
                            <div class="step-item" data-step="1">
                                <i class="fas fa-circle text-muted"></i> Сбор данных
                            </div>
                            <div class="step-item" data-step="2">
                                <i class="fas fa-circle text-muted"></i> Анализ трендов
                            </div>
                            <div class="step-item" data-step="3">
                                <i class="fas fa-circle text-muted"></i> Транскрибация
                            </div>
                            <div class="step-item" data-step="4">
                                <i class="fas fa-circle text-muted"></i> Переписывание
                            </div>
                            <div class="step-item" data-step="5">
                                <i class="fas fa-circle text-muted"></i> Озвучка
                            </div>
                            <div class="step-item" data-step="6">
                                <i class="fas fa-circle text-muted"></i> Видео
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Основной контент -->
            <div class="col-md-9">
                <!-- Шаг 1: Настройка анализа -->
                <div class="step-card" id="step-1">
                    <h4><i class="fas fa-cog"></i> Настройка анализа трендов</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Период анализа (дней назад)</label>
                                <select class="form-select" id="days-back">
                                    <option value="7">7 дней</option>
                                    <option value="14">14 дней</option>
                                    <option value="30">30 дней</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Конкуренты (через запятую)</label>
                                <textarea class="form-control" id="competitors" rows="3" 
                                    placeholder="@competitor1, @competitor2, @competitor3"></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Минимальные просмотры для виральности</label>
                                <input type="number" class="form-control" id="min-views" value="25000">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Минимальный engagement rate (%)</label>
                                <input type="number" class="form-control" id="min-engagement" value="5" step="0.1">
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="startAnalysis()">
                        <i class="fas fa-play"></i> Запустить анализ
                    </button>
                </div>

                <!-- Шаг 2: Результаты анализа -->
                <div class="step-card" id="step-2" style="display: none;">
                    <h4><i class="fas fa-table"></i> Результаты анализа конкурентов</h4>
                    <div class="mb-3">
                        <div class="row">
                            <div class="col-md-6">
                                <input type="text" class="form-control" id="search-competitors" placeholder="Поиск по конкурентам...">
                            </div>
                            <div class="col-md-6">
                                <select class="form-select" id="sort-competitors">
                                    <option value="engagement_rate">По engagement rate</option>
                                    <option value="views">По просмотрам</option>
                                    <option value="likes">По лайкам</option>
                                    <option value="date">По дате</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="competitor-table">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Конкурент</th>
                                    <th>Просмотры</th>
                                    <th>Лайки</th>
                                    <th>Комментарии</th>
                                    <th>Engagement</th>
                                    <th>Дата</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="competitors-table">
                                <!-- Данные загружаются динамически -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Шаг 3: Транскрибация -->
                <div class="step-card" id="step-3" style="display: none;">
                    <h4><i class="fas fa-microphone"></i> Транскрибация видео</h4>
                    <div id="transcription-status">
                        <div class="alert alert-info">
                            <i class="fas fa-spinner fa-spin"></i> Транскрибируем видео...
                        </div>
                    </div>
                    <div id="transcription-result" style="display: none;">
                        <h5>Результат транскрибации:</h5>
                        <div class="text-editor" id="transcript-text" contenteditable="true"></div>
                        <button class="btn btn-success mt-2" onclick="proceedToRewrite()">
                            <i class="fas fa-arrow-right"></i> Перейти к переписыванию
                        </button>
                    </div>
                </div>

                <!-- Шаг 4: Переписывание -->
                <div class="step-card" id="step-4" style="display: none;">
                    <h4><i class="fas fa-edit"></i> Переписывание текста</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Оригинальный текст:</h6>
                            <div class="text-editor" id="original-text" readonly></div>
                        </div>
                        <div class="col-md-6">
                            <h6>Переписанный текст:</h6>
                            <div class="text-editor" id="rewritten-text" contenteditable="true"></div>
                            <div class="mt-2">
                                <button class="btn btn-primary" onclick="rewriteText()">
                                    <i class="fas fa-magic"></i> Переписать с AI
                                </button>
                                <button class="btn btn-success" onclick="proceedToVoice()">
                                    <i class="fas fa-arrow-right"></i> Перейти к озвучке
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Шаг 5: Озвучка -->
                <div class="step-card" id="step-5" style="display: none;">
                    <h4><i class="fas fa-volume-up"></i> Настройка озвучки</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Выбор голоса</label>
                                <select class="form-select" id="voice-select">
                                    <option value="default">Стандартный голос</option>
                                    <option value="female">Женский голос</option>
                                    <option value="male">Мужской голос</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Стабильность: <span id="stability-value">0.5</span></label>
                                <input type="range" class="form-range" id="stability" min="0" max="1" step="0.1" value="0.5">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Сходство: <span id="similarity-value">0.5</span></label>
                                <input type="range" class="form-range" id="similarity" min="0" max="1" step="0.1" value="0.5">
                            </div>
                            <button class="btn btn-primary" onclick="generateVoice()">
                                <i class="fas fa-play"></i> Генерировать озвучку
                            </button>
                        </div>
                        <div class="col-md-6">
                            <div id="voice-result" style="display: none;">
                                <h6>Результат озвучки:</h6>
                                <audio controls class="audio-player" id="generated-audio"></audio>
                                <div class="mt-2">
                                    <button class="btn btn-success" onclick="proceedToVideo()">
                                        <i class="fas fa-arrow-right"></i> Перейти к видео
                                    </button>
                                    <button class="btn btn-warning" onclick="regenerateVoice()">
                                        <i class="fas fa-redo"></i> Перегенерировать
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Шаг 6: Создание видео -->
                <div class="step-card" id="step-6" style="display: none;">
                    <h4><i class="fas fa-video"></i> Создание видео</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Выбор аватара</label>
                                <select class="form-select" id="avatar-select">
                                    <option value="default">Стандартный аватар</option>
                                    <option value="female">Женский аватар</option>
                                    <option value="male">Мужской аватар</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Стиль одежды</label>
                                <select class="form-select" id="clothing-style">
                                    <option value="casual">Повседневный</option>
                                    <option value="business">Деловой</option>
                                    <option value="formal">Официальный</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="generateVideo()">
                                <i class="fas fa-video"></i> Создать видео
                            </button>
                        </div>
                        <div class="col-md-6">
                            <div id="video-result" style="display: none;">
                                <h6>Результат видео:</h6>
                                <video controls class="video-preview" id="generated-video"></video>
                                <div class="mt-2">
                                    <button class="btn btn-success" onclick="downloadVideo()">
                                        <i class="fas fa-download"></i> Скачать видео
                                    </button>
                                    <button class="btn btn-primary" onclick="startNewAnalysis()">
                                        <i class="fas fa-plus"></i> Новый анализ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentAnalysisId = null;
        let currentStep = 1;

        // Обновление слайдеров
        document.getElementById('stability').addEventListener('input', function() {
            document.getElementById('stability-value').textContent = this.value;
        });
        document.getElementById('similarity').addEventListener('input', function() {
            document.getElementById('similarity-value').textContent = this.value;
        });

        function startAnalysis() {
            const competitors = document.getElementById('competitors').value.split(',').map(c => c.trim());
            const daysBack = parseInt(document.getElementById('days-back').value);
            const minViews = parseInt(document.getElementById('min-views').value);
            const minEngagement = parseFloat(document.getElementById('min-engagement').value);

            // Создаем уникальный task_id
            const taskId = 'trends_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            currentAnalysisId = taskId;

            // Запускаем анализ конкурентов
            fetch('/api/trends/start-step-generation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    task_id: taskId,
                    step: 'analyze',
                    kwargs: {
                        days_back: daysBack,
                        competitors: competitors
                    }
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showStep(2);
                    updateProgress(20);
                    pollAnalysisStatus();
                } else {
                    alert('Ошибка: ' + data.message);
                }
            });
        }

        function pollAnalysisStatus() {
            if (!currentAnalysisId) return;

            // Используем WebSocket для получения обновлений прогресса
            // Пока что симулируем успешный анализ
            setTimeout(() => {
                // Симулируем данные конкурентов
                const mockCompetitors = [
                    {
                        id: 1,
                        competitor_handle: 'example_user1',
                        views: 45000,
                        likes: 2500,
                        comments: 150,
                        engagement_rate: 5.9,
                        post_date: new Date().toISOString(),
                        is_selected: false
                    },
                    {
                        id: 2,
                        competitor_handle: 'example_user2',
                        views: 32000,
                        likes: 1800,
                        comments: 95,
                        engagement_rate: 5.9,
                        post_date: new Date().toISOString(),
                        is_selected: false
                    }
                ];
                
                displayCompetitors(mockCompetitors);
                updateProgress(40);
            }, 3000);
        }

        function loadCompetitors() {
            fetch(`/api/trends/analysis/${currentAnalysisId}/competitors`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayCompetitors(data.competitors);
                }
            });
        }

        function displayCompetitors(competitors) {
            const tbody = document.getElementById('competitors-table');
            tbody.innerHTML = '';

            competitors.forEach(comp => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>@${comp.competitor_handle}</td>
                    <td>${comp.views.toLocaleString()}</td>
                    <td>${comp.likes.toLocaleString()}</td>
                    <td>${comp.comments.toLocaleString()}</td>
                    <td><span class="badge bg-${comp.engagement_rate > 5 ? 'success' : 'warning'}">${comp.engagement_rate}%</span></td>
                    <td>${new Date(comp.post_date).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="selectPost(${comp.id})">
                            <i class="fas fa-check"></i> Выбрать
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function selectPost(postId) {
            fetch(`/api/trends/analysis/${currentAnalysisId}/select-post`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ post_id: postId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showStep(3);
                    startTranscription();
                }
            });
        }

        function startTranscription() {
            fetch('/api/trends/transcribe', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ analysis_id: currentAnalysisId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    pollTranscriptionStatus();
                }
            });
        }

        function pollTranscriptionStatus() {
            // Здесь должна быть логика опроса статуса транскрибации
            // Пока что симулируем успешную транскрибацию
            setTimeout(() => {
                document.getElementById('transcription-status').style.display = 'none';
                document.getElementById('transcription-result').style.display = 'block';
                document.getElementById('transcript-text').textContent = 'Это пример транскрибированного текста...';
                updateProgress(60);
            }, 3000);
        }

        function proceedToRewrite() {
            showStep(4);
            document.getElementById('original-text').textContent = document.getElementById('transcript-text').textContent;
            updateProgress(70);
        }

        function rewriteText() {
            const originalText = document.getElementById('original-text').textContent;
            
            fetch('/api/trends/rewrite', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    analysis_id: currentAnalysisId,
                    transcript_text: originalText
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Симулируем результат переписывания
                    document.getElementById('rewritten-text').textContent = 'Это переписанный AI текст, более привлекательный для социальных сетей...';
                }
            });
        }

        function proceedToVoice() {
            showStep(5);
            updateProgress(80);
        }

        function generateVoice() {
            const text = document.getElementById('rewritten-text').textContent;
            const voiceSettings = {
                voice_id: document.getElementById('voice-select').value,
                stability: parseFloat(document.getElementById('stability').value),
                similarity_boost: parseFloat(document.getElementById('similarity').value)
            };

            fetch('/api/trends/voice/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    analysis_id: currentAnalysisId,
                    text: text,
                    voice_settings: voiceSettings
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('voice-result').style.display = 'block';
                    // Здесь должен быть реальный URL аудио файла
                    document.getElementById('generated-audio').src = '/static/audio/sample.mp3';
                }
            });
        }

        function proceedToVideo() {
            showStep(6);
            updateProgress(90);
        }

        function generateVideo() {
            const audioFileUrl = document.getElementById('generated-audio').src;
            const avatarSettings = {
                avatar_id: document.getElementById('avatar-select').value,
                clothing_style: document.getElementById('clothing-style').value
            };

            fetch('/api/trends/video/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    analysis_id: currentAnalysisId,
                    audio_file_url: audioFileUrl,
                    avatar_settings: avatarSettings
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('video-result').style.display = 'block';
                    // Здесь должен быть реальный URL видео файла
                    document.getElementById('generated-video').src = '/static/video/sample.mp4';
                    updateProgress(100);
                }
            });
        }

        function showStep(step) {
            // Скрываем все шаги
            for (let i = 1; i <= 6; i++) {
                document.getElementById(`step-${i}`).style.display = 'none';
            }
            
            // Показываем нужный шаг
            document.getElementById(`step-${step}`).style.display = 'block';
            currentStep = step;
        }

        function updateProgress(percentage) {
            document.getElementById('overall-progress').style.width = percentage + '%';
            
            // Обновляем статус шагов
            for (let i = 1; i <= 6; i++) {
                const stepItem = document.querySelector(`.step-item[data-step="${i}"]`);
                const icon = stepItem.querySelector('i');
                
                if (i < currentStep) {
                    icon.className = 'fas fa-check-circle text-success';
                } else if (i === currentStep) {
                    icon.className = 'fas fa-spinner fa-spin text-primary';
                } else {
                    icon.className = 'fas fa-circle text-muted';
                }
            }
        }

        function startNewAnalysis() {
            location.reload();
        }
    </script>
</body>
</html>
