{% extends "base.html" %}

{% block title %}–ú–æ–¥—É–ª—å –¢—Ä–µ–Ω–¥–≤–æ—Ç—á–∏–Ω–≥–∞ - –ö–æ–Ω—Ç–µ–Ω—Ç –ó–∞–≤–æ–¥{% endblock %}

{% block extra_head %}
<!-- Plyr CSS -->
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
<!-- Plyr JS -->
<script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>

<script>
// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º–∏

async function loadCompetitors() {
    console.log('üîÑ –ó–ê–ì–†–£–ó–ö–ê –ö–û–ù–ö–£–†–ï–ù–¢–û–í - –ù–ê–ß–ê–õ–û');
    const container = document.getElementById('competitorsList');
    const countEl = document.getElementById('competitorsCount');
    
    if (!container) {
        console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç competitorsList –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    
    container.innerHTML = `
        <div class="text-center text-primary p-3">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            <span>–ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤...</span>
        </div>`;
    
    try {
        console.log('üì° –û–¢–ü–†–ê–í–õ–Ø–ï–ú –ó–ê–ü–†–û–° –ö /api/competitors');
        const response = await fetch('/api/competitors');
        console.log('üì° –û–¢–í–ï–¢ –ü–û–õ–£–ß–ï–ù:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const competitors = await response.json();
        console.log('üìä –î–ê–ù–ù–´–ï –ü–û–õ–£–ß–ï–ù–´:', competitors.length);

        if (!Array.isArray(competitors) || competitors.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted p-3">
                    <i class="fas fa-users fa-2x mb-2 text-muted"></i>
                    <div>–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</div>
                </div>`;
            if (countEl) countEl.textContent = '0';
            return;
        }

        console.log('‚úÖ –†–ï–ù–î–ï–†–ò–ú –°–ü–ò–°–û–ö –ö–û–ù–ö–£–†–ï–ù–¢–û–í –í –°–¢–ò–õ–ï EXCEL');
        container.innerHTML = `
            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                <table class="table table-sm table-bordered table-hover mb-0" style="font-size: 14px;">
                    <thead class="table-dark sticky-top">
                        <tr>
                            <th width="40" class="text-center">
                                <input type="checkbox" id="selectAll" onchange="toggleAllCompetitors()" class="form-check-input">
                            </th>
                            <th width="60" class="text-center">‚Ññ</th>
                            <th>–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç</th>
                            <th width="100" class="text-center">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</th>
                            <th width="80" class="text-center">–°—Ç–∞—Ç—É—Å</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${competitors.map((comp, index) => `
                            <tr class="align-middle">
                                <td class="text-center">
                                    <input type="checkbox" value="${comp.username}" id="comp_${comp.id}" ${index === 0 ? 'checked' : ''} onchange="updateCompetitorCount()" class="form-check-input">
                                </td>
                                <td class="text-center fw-bold text-muted">${index + 1}</td>
                                <td>
                    <div class="d-flex align-items-center">
                                        <i class="fas fa-user-circle me-2 text-primary"></i>
                                        <span class="fw-bold">@${comp.username}</span>
                        </div>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-info">${comp.platform}</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-success">–ê–∫—Ç–∏–≤–µ–Ω</span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                    </div>
        `;
        
        if (countEl) countEl.textContent = competitors.length;
        
        console.log('‚úÖ –ö–û–ù–ö–£–†–ï–ù–¢–´ –ó–ê–ì–†–£–ñ–ï–ù–´ –£–°–ü–ï–®–ù–û:', competitors.length);
        
    } catch (error) {
        console.error('‚ùå –û–®–ò–ë–ö–ê:', error);
        container.innerHTML = `
            <div class="text-center text-danger p-3">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
                <small>${error.message}</small>
            </div>`;
        if (countEl) countEl.textContent = '0';
    }
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∞–±–ª–∏—Ü–µ–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
function toggleAllCompetitors() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('#competitorsList input[type="checkbox"]:not(#selectAll)');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    
    updateCompetitorCount();
}

function updateCompetitorCount() {
    const checkedBoxes = document.querySelectorAll('#competitorsList input[type="checkbox"]:not(#selectAll):checked');
    const countEl = document.getElementById('competitorsCount');
    const selectAll = document.getElementById('selectAll');
    
    if (countEl) {
        countEl.textContent = checkedBoxes.length;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ—Ö"
    if (selectAll) {
        const allBoxes = document.querySelectorAll('#competitorsList input[type="checkbox"]:not(#selectAll)');
        selectAll.checked = checkedBoxes.length === allBoxes.length;
        selectAll.indeterminate = checkedBoxes.length > 0 && checkedBoxes.length < allBoxes.length;
    }
}

// –§—É–Ω–∫—Ü–∏—è —Å–±–æ—Ä–∞ —Ä–∏–ª—Å–æ–≤ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º —Ç–∞–π–º–∞—É—Ç–æ–º
async function collectReels(event) {
    event.preventDefault();
    console.log('üé¨ –ù–ê–ß–ò–ù–ê–ï–ú –°–ë–û–† –†–ò–õ–°–û–í –ö–û–ù–ö–£–†–ï–ù–¢–û–í');
    
    const button = document.getElementById('collectButton');
    const statusDiv = document.getElementById('collectStatus');
    const reelsCount = document.getElementById('reelsCount').value;
    const dataSource = document.getElementById('dataSource').value;
    
    // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    const selectedCompetitors = [];
    const checkboxes = document.querySelectorAll('#competitorsList input[type="checkbox"]:not(#selectAll):checked');
    
    checkboxes.forEach(checkbox => {
        selectedCompetitors.push(checkbox.value);
    });
    
    if (selectedCompetitors.length === 0) {
        statusDiv.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞
            </div>`;
        return;
    }
    
    console.log('üìä –í–´–ë–†–ê–ù–ù–´–ï –ö–û–ù–ö–£–†–ï–ù–¢–´:', selectedCompetitors);
    console.log('üìä –ö–û–õ–ò–ß–ï–°–¢–í–û –†–ò–õ–°–û–í:', reelsCount);
    console.log('üìä –ò–°–¢–û–ß–ù–ò–ö –î–ê–ù–ù–´–•:', dataSource);
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>–°–æ–±–∏—Ä–∞–µ–º —Ä–∏–ª—Å—ã...';
    
    statusDiv.innerHTML = `
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä —Ä–∏–ª—Å–æ–≤ –¥–ª—è ${selectedCompetitors.length} –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤...
            <br><small class="text-muted">–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç</small>
        </div>`;
    
    try {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º endpoint –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
        const endpoint = dataSource === 'phantombuster' 
            ? '/api/trends/collect-reels-phantombuster'
            : '/api/trends/collect-reels';
        
        console.log('üì° –û–¢–ü–†–ê–í–õ–Ø–ï–ú –ó–ê–ü–†–û–° –ù–ê –°–ë–û–† –†–ò–õ–°–û–í');
        console.log('üìä –ü–ê–†–ê–ú–ï–¢–†–´:', { competitors: selectedCompetitors, count: parseInt(reelsCount) });
        console.log('üìä ENDPOINT:', endpoint);
        console.log('‚è∞ –¢–ê–ô–ú–ê–£–¢ –£–°–¢–ê–ù–û–í–õ–ï–ù –ù–ê 10 –ú–ò–ù–£–¢');
        console.log('üîÑ RETRY –õ–û–ì–ò–ö–ê: 3 –ø–æ–ø—ã—Ç–∫–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π');
        
        // Retry –ª–æ–≥–∏–∫–∞: 3 –ø–æ–ø—ã—Ç–∫–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
        let attempt = 1;
        const maxAttempts = 3;
        let lastError = null;
        
        while (attempt <= maxAttempts) {
            try {
                console.log(`üîÑ –ü–û–ü–´–¢–ö–ê ${attempt}/${maxAttempts}`);
        
        // –°–æ–∑–¥–∞–µ–º AbortController –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è —Ç–∞–π–º–∞—É—Ç–∞
        const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 1200000); // 20 –º–∏–Ω—É—Ç —Ç–∞–π–º–∞—É—Ç –¥–ª—è —Ç—è–∂–µ–ª—ã—Ö –Ω–∞–≥—Ä—É–∑–æ–∫
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                competitors: selectedCompetitors,
                count: parseInt(reelsCount)
            }),
            signal: controller.signal,
            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–ª—è —Ç—è–∂–µ–ª—ã—Ö –Ω–∞–≥—Ä—É–∑–æ–∫ (200+ —Ä–∏–ª—Å–æ–≤)
            timeout: 1200000  // 20 –º–∏–Ω—É—Ç –¥–ª—è —Ç—è–∂–µ–ª—ã—Ö –Ω–∞–≥—Ä—É–∑–æ–∫
        });
        
        clearTimeout(timeoutId);
        console.log('üì° –û–¢–í–ï–¢ –ü–û–õ–£–ß–ï–ù:', response.status);
                    console.log('‚è∞ –í–†–ï–ú–Ø –û–¢–í–ï–¢–ê:', new Date().toLocaleTimeString());
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('üìä –†–ï–ó–£–õ–¨–¢–ê–¢ –°–ë–û–†–ê:', result);
        
        if (result.success) {
            statusDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    –£—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω–æ ${result.total_count || result.total_reels || 0} —Ä–∏–ª—Å–æ–≤ –æ—Ç ${selectedCompetitors.length} –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
                    <br><small class="text-muted">–í–∏—Ä–∞–ª—å–Ω—ã—Ö: ${result.viral_count || 0}</small>
        </div>`;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
            window.collectedReelsData = result;
            window.collectedReels = result.reels;
            console.log('üíæ –î–∞–Ω–Ω—ã–µ —Ä–∏–ª—Å–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã:', result);
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥
            activateStep2();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            updateReelsStats(result);
            
        } else {
            throw new Error(result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        }
        
                // –ï—Å–ª–∏ –¥–æ—à–ª–∏ —Å—é–¥–∞, –∑–Ω–∞—á–∏—Ç —É—Å–ø–µ—à–Ω–æ
                break;
                
            } catch (error) {
                console.error(`‚ùå –û–®–ò–ë–ö–ê –ü–û–ü–´–¢–ö–ò ${attempt}:`, error);
                lastError = error;
                attempt++;
                
                if (attempt <= maxAttempts) {
                    console.log(`‚è≥ –ñ–î–ï–ú 5 –°–ï–ö–£–ù–î –ü–ï–†–ï–î –ü–û–í–¢–û–†–ù–û–ô –ü–û–ü–´–¢–ö–û–ô...`);
                    statusDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-spinner fa-spin me-2"></i>
                            –ü–æ–ø—ã—Ç–∫–∞ ${attempt-1} –Ω–µ —É–¥–∞–ª–∞—Å—å. –ü–æ–≤—Ç–æ—Ä—è–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥... (${attempt}/${maxAttempts})
                        </div>`;
                    await new Promise(resolve => setTimeout(resolve, 5000));
                }
            }
        }
        
        // –ï—Å–ª–∏ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã
        if (attempt > maxAttempts) {
            throw lastError;
        }
        
    } catch (error) {
        console.error('‚ùå –û–®–ò–ë–ö–ê –°–ë–û–†–ê –†–ò–õ–°–û–í:', error);
        
        let errorMessage = error.message;
        if (error.name === 'AbortError') {
            errorMessage = '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è (10 –º–∏–Ω—É—Ç). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∏–ª—Å–æ–≤.';
        }
        
        statusDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∞ —Ä–∏–ª—Å–æ–≤: ${errorMessage}
                <br><small class="text-muted">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∏–ª—Å–æ–≤ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</small>
            </div>`;
    } finally {
        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-cloud-download-alt me-2"></i>–°–æ–±—Ä–∞—Ç—å —Ä–∏–ª—Å—ã –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤';
    }
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ä–∏–ª—Å–æ–≤
function updateReelsStats(result) {
    const totalReels = document.getElementById('totalReels');
    const viralReels = document.getElementById('viralReels');
    
    if (totalReels) {
        totalReels.textContent = result.total_count || result.total_reels || 0;
    }
    
    if (viralReels) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–º–µ—Å—Ç–æ –≤–∏—Ä–∞–ª—å–Ω—ã—Ö
        viralReels.textContent = result.total_count || result.total_reels || 0;
    }
}

// –§—É–Ω–∫—Ü–∏—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –≤—Ç–æ—Ä–æ–≥–æ —à–∞–≥–∞ —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —Ä–∏–ª—Å–æ–≤
function activateStep2() {
    const step2 = document.getElementById('step2');
    if (step2) {
        step2.classList.remove('step-disabled');
        step2.classList.add('step-active');
        console.log('‚úÖ –®–∞–≥ 2 –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ —Ä–∏–ª—Å—ã
        loadCollectedReels();
    }
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö —Ä–∏–ª—Å–æ–≤
function loadCollectedReels() {
    console.log('üé¨ –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ —Ä–∏–ª—Å—ã...');
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –∏–ª–∏ –¥–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å
    if (window.collectedReelsData) {
        displayReels(window.collectedReelsData);
    } else {
        // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        const reelsList = document.getElementById('reelsList');
        if (reelsList) {
            reelsList.innerHTML = `
                <div class="col-12 text-center text-muted p-4">
                    <i class="fas fa-video fa-2x mb-2"></i>
                    <div>–†–∏–ª—Å—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</div>
                    </div>
            `;
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–∏–ª—Å–æ–≤
function displayReels(reelsData) {
    console.log('üì∫ –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–∏–ª—Å—ã:', reelsData);
    
    const reelsList = document.getElementById('reelsList');
    if (!reelsList) return;
    
    if (!reelsData || !reelsData.reels || reelsData.reels.length === 0) {
        reelsList.innerHTML = `
            <div class="col-12 text-center text-muted p-4">
                <i class="fas fa-video fa-2x mb-2"></i>
                <div>–†–∏–ª—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
                </div>
        `;
            return;
        }

    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–∏–ª—Å—ã –≤ –≤–∏–¥–µ –∫–∞—Ä—Ç–æ—á–µ–∫
    reelsList.innerHTML = reelsData.reels.map((reel, index) => `
        <div class="col-md-6 col-lg-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-title mb-0">–†–∏–ª—Å ${index + 1}</h6>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="showReelPreview(${index})">
                                <i class="fas fa-play me-1"></i>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                            </button>
                            <button class="btn btn-sm btn-success" onclick="confirmReelSelection(${index})">
                                <i class="fas fa-check me-1"></i>–í—ã–±—Ä–∞—Ç—å
                </button>
            </div>
        </div>
                    
                    <div class="mb-2">
                        <small class="text-muted">${reel.caption ? reel.caption.substring(0, 100) + '...' : '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</small>
                        ${reel.url ? `
                            <div class="mt-1">
                                <a href="${reel.url}" target="_blank" class="btn btn-sm btn-outline-secondary">
                                    <i class="fab fa-instagram me-1"></i>–û—Ç–∫—Ä—ã—Ç—å –≤ Instagram
                                </a>
    </div>
                        ` : ''}
</div>

                    <div class="row g-2 text-center">
                        <div class="col-4">
                            <div class="text-primary fw-bold">${reel.views_count || 0}</div>
                            <small class="text-muted">–ü—Ä–æ—Å–º–æ—Ç—Ä—ã</small>
                    </div>
                        <div class="col-4">
                            <div class="text-danger fw-bold">${reel.likes_count || 0}</div>
                            <small class="text-muted">–õ–∞–π–∫–∏</small>
                </div>
                        <div class="col-4">
                            <div class="text-info fw-bold">${reel.comments_count || 0}</div>
                            <small class="text-muted">–ö–æ–º–º–µ–Ω—Ç—ã</small>
                </div>
            </div>

                    ${reel.hashtags && reel.hashtags.length > 0 ? `
                        <div class="mt-2">
                            ${reel.hashtags.slice(0, 3).map(tag => `<span class="badge bg-light text-dark me-1">#${tag}</span>`).join('')}
                </div>
                    ` : ''}
                </div>
            </div>
            </div>
    `).join('');
}

// –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ —Ä–∏–ª—Å–∞
function selectReel(reelIndex) {
    console.log('‚úÖ –í—ã–±—Ä–∞–Ω —Ä–∏–ª—Å:', reelIndex);
    
    // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö —Ä–∏–ª—Å–æ–≤
    document.querySelectorAll('#reelsList .btn-primary').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
    });
    
    // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–∏–ª—Å (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–µ–ª–µ–∫—Ç–æ—Ä)
    const selectedBtn = document.querySelectorAll('#reelsList .btn')[reelIndex];
    if (selectedBtn) {
        selectedBtn.classList.remove('btn-outline-primary');
        selectedBtn.classList.add('btn-primary');
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º
    showReelPreview(reelIndex);
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º —Ä–∏–ª—Å–∞
function showReelPreview(reelIndex) {
    console.log('üé¨ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ä–∏–ª—Å–∞:', reelIndex);
    
    if (!window.collectedReelsData || !window.collectedReelsData.reels) {
        console.error('‚ùå –î–∞–Ω–Ω—ã–µ —Ä–∏–ª—Å–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
            return;
        }

    const reel = window.collectedReelsData.reels[reelIndex];
    if (!reel) {
        console.error('‚ùå –†–∏–ª—Å –Ω–µ –Ω–∞–π–¥–µ–Ω:', reelIndex);
            return;
        }

    // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modalHtml = `
        <div class="modal fade" id="reelPreviewModal" tabindex="-1" aria-labelledby="reelPreviewModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="reelPreviewModalLabel">
                            <i class="fas fa-video me-2"></i>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ä–∏–ª—Å–∞ ${reelIndex + 1}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="ratio ratio-16x9 mb-3">
                                    ${reel.video_url ? `
                                        <video controls class="w-100 h-100" preload="metadata">
                                            <source src="${reel.video_url}" type="video/mp4">
                                            <source src="${reel.video_url}" type="video/webm">
                                            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç.
                                        </video>
                                    ` : `
                                        <div class="d-flex align-items-center justify-content-center bg-light border rounded">
                                            <div class="text-center text-muted">
                                                <i class="fas fa-video fa-3x mb-2"></i>
                                                <div>–í–∏–¥–µ–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ</div>
                                                <small>URL: ${reel.url || '–ù–µ —É–∫–∞–∑–∞–Ω'}</small>
            </div>
        </div>
                                    `}
    </div>
</div>
                <div class="col-md-4">
                                <h6 class="fw-bold">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</h6>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã:</span>
                                        <span class="fw-bold text-primary">${reel.views_count || 0}</span>
                </div>
                                    <div class="d-flex justify-content-between">
                                        <span>–õ–∞–π–∫–∏:</span>
                                        <span class="fw-bold text-danger">${reel.likes_count || 0}</span>
                </div>
                                    <div class="d-flex justify-content-between">
                                        <span>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:</span>
                                        <span class="fw-bold text-info">${reel.comments_count || 0}</span>
                </div>
            </div>
            
                                <h6 class="fw-bold">–û–ø–∏—Å–∞–Ω–∏–µ:</h6>
                                <p class="text-muted small">${reel.caption || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                                
                                ${reel.url ? `
                                    <h6 class="fw-bold">–°—Å—ã–ª–∫–∞:</h6>
                                    <div class="mb-2">
                                        <a href="${reel.url}" target="_blank" class="btn btn-sm btn-outline-primary">
                                            <i class="fab fa-instagram me-1"></i>–û—Ç–∫—Ä—ã—Ç—å –≤ Instagram
                                        </a>
        </div>
                                ` : ''}
                                
                                ${reel.hashtags && reel.hashtags.length > 0 ? `
                                    <h6 class="fw-bold">–•–µ—à—Ç–µ–≥–∏:</h6>
                                    <div class="mb-2">
                                        ${reel.hashtags.slice(0, 5).map(tag => `<span class="badge bg-light text-dark me-1 mb-1">#${tag}</span>`).join('')}
                </div>
                                ` : ''}
            </div>
                </div>
                </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>–ó–∞–∫—Ä—ã—Ç—å
            </button>
                        <button type="button" class="btn btn-gsr-accent" onclick="confirmReelSelection(${reelIndex})" data-bs-dismiss="modal">
                            <i class="fas fa-check me-2"></i>–í—ã–±—Ä–∞—Ç—å —ç—Ç–æ—Ç —Ä–∏–ª—Å
                        </button>
        </div>
    </div>
</div>
        </div>
    `;
    
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –µ—Å–ª–∏ –µ—Å—Ç—å
    const existingModal = document.getElementById('reelPreviewModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = new bootstrap.Modal(document.getElementById('reelPreviewModal'));
    modal.show();
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞ —Ä–∏–ª—Å–∞
function confirmReelSelection(reelIndex) {
    console.log('‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –≤—ã–±–æ—Ä —Ä–∏–ª—Å–∞:', reelIndex);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
    if (!window.collectedReelsData || !window.collectedReelsData.reels || !window.collectedReelsData.reels[reelIndex]) {
        console.error('‚ùå –î–∞–Ω–Ω—ã–µ —Ä–∏–ª—Å–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
        alert('–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ —Ä–∏–ª—Å–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–±—Ä–∞—Ç—å —Ä–∏–ª—Å—ã –∑–∞–Ω–æ–≤–æ.');
            return;
        }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–∏–ª—Å
    window.selectedReelIndex = reelIndex;
    window.selectedReel = window.collectedReelsData.reels[reelIndex];
    
    console.log('üìù –í—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–∏–ª—Å:', window.selectedReel);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º UI - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–∏–ª—Å
    updateSelectedReelUI(reelIndex);
    
    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥
    activateStep3();
    
    // –ü–ª–∞–≤–Ω—ã–π —Å–∫—Ä–æ–ª–ª –∫ —à–∞–≥—É 3
    setTimeout(() => {
        const step3 = document.getElementById('step3');
        if (step3) {
            step3.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }, 100);
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–∏–ª—Å–∞
function updateSelectedReelUI(reelIndex) {
    // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –≤—Å–µ—Ö —Ä–∏–ª—Å–æ–≤
    document.querySelectorAll('#reelsList .btn-primary').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
    });
    
    // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–∏–ª—Å
    const selectedBtn = document.querySelectorAll('#reelsList .btn')[reelIndex];
    if (selectedBtn) {
        selectedBtn.classList.remove('btn-outline-primary');
        selectedBtn.classList.add('btn-primary');
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const statusDiv = document.getElementById('collectStatus');
    if (statusDiv) {
        statusDiv.innerHTML = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle me-2"></i>
                –í—ã–±—Ä–∞–Ω —Ä–∏–ª—Å ${reelIndex + 1} –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏
            </div>`;
    }
}

// –§—É–Ω–∫—Ü–∏—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ç—Ä–µ—Ç—å–µ–≥–æ —à–∞–≥–∞
function activateStep3() {
    console.log('‚û°Ô∏è –ê–∫—Ç–∏–≤–∞—Ü–∏—è –®–∞–≥–∞ 3: –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è');
    const step3 = document.getElementById('step3');
    if (step3) {
        step3.classList.remove('step-disabled');
        step3.classList.add('step-active');
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ä–∏–ª—Å–µ
        displaySelectedReelInfo();
    }
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ä–∏–ª—Å–µ
function displaySelectedReelInfo() {
    if (!window.selectedReel) {
        console.error('‚ùå –í—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–∏–ª—Å –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }

    const reel = window.selectedReel;
    const selectedReelInfo = document.getElementById('selectedReelInfo');
    
    if (selectedReelInfo) {
        selectedReelInfo.innerHTML = `
            <div class="alert alert-success d-flex align-items-start">
                <div class="me-3">
                    <i class="fas fa-check-circle fa-2x text-success"></i>
                    </div>
                <div class="flex-grow-1">
                    <h6 class="alert-heading mb-2">–í—ã–±—Ä–∞–Ω —Ä–∏–ª—Å ${window.selectedReelIndex + 1}</h6>
                    <div class="small">
                        <div class="mb-1">
                            <strong>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã:</strong> ${reel.views_count || 0} | 
                            <strong>–õ–∞–π–∫–∏:</strong> ${reel.likes_count || 0} | 
                            <strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:</strong> ${reel.comments_count || 0}
                    </div>
                        ${reel.caption ? `
                            <div class="text-muted">
                                <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${reel.caption.substring(0, 100)}${reel.caption.length > 100 ? '...' : ''}
                </div>
                        ` : ''}
                        ${reel.url ? `
                            <div class="mt-2">
                                <a href="${reel.url}" target="_blank" class="btn btn-sm btn-outline-primary">
                                    <i class="fab fa-instagram me-1"></i>–û—Ç–∫—Ä—ã—Ç—å –≤ Instagram
                                </a>
                    </div>
                        ` : ''}
                </div>
            </div>
            </div>
        `;
        selectedReelInfo.style.display = 'block';
    }
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —à–∞–≥–æ–≤
async function transcribeSelectedReel() {
    console.log('üé§ –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–∏–ª—Å–∞ —Å AssemblyAI...');
    const statusDiv = document.getElementById('transcribeStatus');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ä–∏–ª—Å –≤—ã–±—Ä–∞–Ω
    if (!window.selectedReel) {
        statusDiv.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–∏–ª—Å –Ω–∞ —à–∞–≥–µ 2
            </div>`;
        return;
    }
    
    statusDiv.innerHTML = `
        <div class="alert alert-info">
            <i class="fas fa-spinner fa-spin me-2"></i>
            –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ–º —Ä–∏–ª—Å —Å –ø–æ–º–æ—â—å—é AssemblyAI... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.
        </div>`;
    
    try {
        console.log('üì° –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—é...');
        
        const response = await fetch('/api/trends/transcribe', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                video_url: window.selectedReel.video_url || window.selectedReel.url,
                assemblyai_key: 'e4b374b6b23642cdafecfa3e92da87a5'
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('üìä –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏:', result);
        
        if (result.success) {
            statusDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –¢–µ–∫—Å—Ç –∏–∑–≤–ª–µ—á–µ–Ω –∏–∑ ${result.duration || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–π'} —Å–µ–∫—É–Ω–¥ –∞—É–¥–∏–æ.
                </div>`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            document.getElementById('transcriptResult').style.display = 'block';
            document.getElementById('transcriptText').value = result.transcript || '–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞';
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç
            window.transcriptText = result.transcript;
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥
            activateStep4();
            
        } else {
            throw new Error(result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏');
        }
        
    } catch (error) {
        console.error('‚ùå –û–®–ò–ë–ö–ê –¢–†–ê–ù–°–ö–†–ò–ë–ê–¶–ò–ò:', error);
        
        statusDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                –û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏: ${error.message}
                <br><small class="text-muted">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ URL –≤–∏–¥–µ–æ</small>
            </div>`;
    }
}

function activateStep4() {
    console.log('‚û°Ô∏è –ê–∫—Ç–∏–≤–∞—Ü–∏—è –®–∞–≥–∞ 4: –ü–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏–µ');
    const step4 = document.getElementById('step4');
    if (step4) {
        step4.classList.remove('step-disabled');
        step4.classList.add('step-active');
    }
}

async function rewriteTranscript() {
    console.log('‚úèÔ∏è –ü–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞...');
    const statusDiv = document.getElementById('rewriteStatus');
    const transcriptText = document.getElementById('transcriptText').value;
    
    if (!transcriptText || transcriptText.trim() === '') {
        statusDiv.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—é –Ω–∞ —à–∞–≥–µ 3
            </div>`;
        return;
    }
    
    statusDiv.innerHTML = `
        <div class="alert alert-info">
            <i class="fas fa-spinner fa-spin me-2"></i>
            –ü–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç —Å –ø–æ–º–æ—â—å—é –ò–ò...
        </div>`;
    
    try {
        const response = await fetch('/api/trends/rewrite', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                transcript: transcriptText
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            statusDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    –¢–µ–∫—Å—Ç –ø–µ—Ä–µ–ø–∏—Å–∞–Ω OpenAI!
                </div>`;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
            window.rewrittenText = result.rewritten_text;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            document.getElementById('rewrittenResult').style.display = 'block';
            document.getElementById('rewrittenText').textContent = result.rewritten_text;
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º textarea –≤ Step 5
            document.getElementById('editableText').value = result.rewritten_text;
            updateTextStats(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥
            activateStep5();
        } else {
            statusDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏—è: ${result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
                </div>`;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏—è:', error);
        statusDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏—è: ${error.message}
            </div>`;
    }
}

function activateStep5() {
    console.log('‚û°Ô∏è –ê–∫—Ç–∏–≤–∞—Ü–∏—è –®–∞–≥–∞ 5: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—É–¥–∏–æ');
    const step5 = document.getElementById('step5');
    if (step5) {
        step5.classList.remove('step-disabled');
        step5.classList.add('step-active');
    }
}

function updateTextStats() {
    const textarea = document.getElementById('editableText');
    const statsDiv = document.getElementById('textStats');
    const text = textarea.value;
    const charCount = text.length;
    
    // –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è: 150-180 —Å–∏–º–≤–æ–ª–æ–≤ –≤ –º–∏–Ω—É—Ç—É, –±–µ—Ä–µ–º —Å—Ä–µ–¥–Ω–µ–µ 165
    const secondsEstimate = Math.ceil((charCount / 165) * 60);
    const minutes = Math.floor(secondsEstimate / 60);
    const seconds = secondsEstimate % 60;
    
    let timeText = '';
    if (minutes > 0) {
        timeText = `~${minutes} –º–∏–Ω ${seconds} —Å–µ–∫`;
    } else {
        timeText = `~${seconds} —Å–µ–∫`;
    }
    
    statsDiv.textContent = `–°–∏–º–≤–æ–ª–æ–≤: ${charCount} | –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è: ${timeText}`;
}

async function generateAudio() {
    console.log('üéµ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—É–¥–∏–æ —á–µ—Ä–µ–∑ ElevenLabs...');
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ –ø–æ–ª—è
    const text = document.getElementById('editableText').value;
    
    if (!text || text.trim() === '') {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –æ–∑–≤—É—á–∫–∏');
        return;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    const voiceId = document.getElementById('voiceSelect')?.value || 'jP9L6ZC55cz5mmx4ZpCk';
    const modelId = document.getElementById('modelSelect')?.value || 'eleven_flash_v2_5';
    const stability = parseFloat(document.getElementById('stabilitySlider')?.value || 0.5);
    const similarity = parseFloat(document.getElementById('similaritySlider')?.value || 0.5);
    const speed = parseFloat(document.getElementById('speedSlider')?.value || 1.0);
    const useAdvanced = document.getElementById('useAdvanced')?.checked || false;
    
    const statusDiv = document.getElementById('audioStatus');
    statusDiv.innerHTML = `
        <div class="alert alert-info">
            <i class="fas fa-spinner fa-spin me-2"></i>
            –°–æ–∑–¥–∞–µ–º –∞—É–¥–∏–æ —á–µ—Ä–µ–∑ ElevenLabs API...
            <br><small class="text-muted">–ì–æ–ª–æ—Å: ${voiceId}, –ú–æ–¥–µ–ª—å: ${modelId}</small>
        </div>`;
    
    try {
        const requestBody = {
            text: text,
            voice_id: voiceId,
            model_id: modelId,
            speed: speed
        };
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ
        if (useAdvanced) {
            requestBody.use_advanced = true;
            requestBody.stability = stability;
            requestBody.similarity_boost = similarity;
        }
        
        const response = await fetch('/api/trends/generate-audio', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(requestBody)
        });
        
        const result = await response.json();
        
        if (result.success) {
        statusDiv.innerHTML = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle me-2"></i>
                    –ê—É–¥–∏–æ —Å–æ–∑–¥–∞–Ω–æ ElevenLabs!
            </div>`;
        
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º URL –∞—É–¥–∏–æ –¥–ª—è Step 6 (–ø–æ–ª–Ω—ã–π URL –¥–ª—è HeyGen)
            if (result.audio_url.startsWith('/static/')) {
                // –õ–æ–∫–∞–ª—å–Ω—ã–π –ø—É—Ç—å - –¥–µ–ª–∞–µ–º –ø–æ–ª–Ω—ã–π URL
                window.generatedAudioUrl = window.location.origin + result.audio_url;
            } else {
                // –£–∂–µ –ø–æ–ª–Ω—ã–π URL
                window.generatedAudioUrl = result.audio_url;
            }
            console.log('üîó Audio URL –¥–ª—è HeyGen:', window.generatedAudioUrl);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–µ–µ—Ä
        document.getElementById('audioResult').style.display = 'block';
        
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Plyr –ø–ª–µ–µ—Ä
            initializePlyrPlayer(result.audio_url);
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º Step 6
        activateStep6();
        } else {
            throw new Error(result.message || '–û—à–∏–±–∫–∞ API');
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞:', error);
        statusDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                –û—à–∏–±–∫–∞: ${error.message}
            </div>`;
    }
}

function activateStep6() {
    console.log('‚û°Ô∏è –ê–∫—Ç–∏–≤–∞—Ü–∏—è –®–∞–≥–∞ 6: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ');
    const step6 = document.getElementById('step6');
    if (step6) {
        step6.classList.remove('step-disabled');
        step6.classList.add('step-active');
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–≤–∞—Ç–∞—Ä—ã –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ Step 6
        loadAvatars();
    }
}

// Step 6: Video Generation Functions

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è Step 6
window.currentVideoId = null;
window.videoPollingInterval = null;

async function loadAvatars() {
    console.log('üë• –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–≤–∞—Ç–∞—Ä–æ–≤...');
    const avatarSelect = document.getElementById('avatarSelect');
    const avatarPreview = document.getElementById('avatarPreviewImg');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    if (!avatarSelect) {
        console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç avatarSelect –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        return;
    }
    
    try {
        const response = await fetch('/api/trends/avatars');
        const data = await response.json();
        
        if (data.success && data.avatars.length > 0) {
            avatarSelect.innerHTML = '';
            data.avatars.forEach((avatar, index) => {
                const option = document.createElement('option');
                option.value = avatar.avatar_id;
                option.textContent = avatar.avatar_name;
                if (index === 0) option.selected = true;
                avatarSelect.appendChild(option);
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º preview –ø–µ—Ä–≤–æ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞
            if (data.avatars[0] && avatarPreview) {
                const firstAvatar = data.avatars[0];
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ preview –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º
                if (firstAvatar.preview_image_url) {
                    avatarPreview.src = firstAvatar.preview_image_url;
                } else {
                    avatarPreview.src = generateAvatarPreview(firstAvatar.avatar_id, firstAvatar.avatar_name);
                }
                avatarPreview.style.display = 'block';
                
                // –°–∫—Ä—ã–≤–∞–µ–º placeholder
                const placeholder = document.getElementById('avatarPreviewPlaceholder');
                if (placeholder) {
                    placeholder.style.display = 'none';
                }
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞
            avatarSelect.addEventListener('change', function() {
                console.log('üë§ –í—ã–±—Ä–∞–Ω –∞–≤–∞—Ç–∞—Ä:', this.value);
                const selectedAvatar = data.avatars.find(a => a.avatar_id === this.value);
                if (selectedAvatar && avatarPreview) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ preview –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º
                    if (selectedAvatar.preview_image_url) {
                        avatarPreview.src = selectedAvatar.preview_image_url;
                    } else {
                        avatarPreview.src = generateAvatarPreview(selectedAvatar.avatar_id, selectedAvatar.avatar_name);
                    }
                    avatarPreview.style.display = 'block';
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º placeholder
                    const placeholder = document.getElementById('avatarPreviewPlaceholder');
                    if (placeholder) {
                        placeholder.style.display = 'none';
                    }
                }
            });
            
            console.log('‚úÖ –ê–≤–∞—Ç–∞—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', data.avatars.length);
        } else {
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä—ã');
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–æ–≤:', error);
        if (avatarSelect) {
            avatarSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–æ–≤</option>';
        }
    }
}

async function generateVideo() {
    console.log('üé¨ –ù–∞—á–∏–Ω–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –≤–∏–¥–µ–æ...');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞—É–¥–∏–æ
    if (!window.generatedAudioUrl) {
        alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∞—É–¥–∏–æ –Ω–∞ —à–∞–≥–µ 5!');
        return;
    }
    
    // –°–æ–±–∏—Ä–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    const avatarId = document.getElementById('avatarSelect').value;
    const videoFormat = document.querySelector('input[name="videoOrientation"]:checked').value;
    
    console.log('üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏:', { avatarId, videoFormat, audioUrl: window.generatedAudioUrl });
    
    if (!avatarId) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä!');
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    const settingsSection = document.getElementById('videoSettingsSection');
    const progressSection = document.getElementById('videoProgressSection');
    
    if (!settingsSection || !progressSection) {
        console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç—ã Step 6 –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!');
        alert('–û—à–∏–±–∫–∞: —ç–ª–µ–º–µ–Ω—Ç—ã Step 6 –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Step 6 –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.');
        return;
    }
    
    console.log('‚úÖ –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–µ–∫—Ü–∏–∏');
    
    // –°–∫—Ä—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    settingsSection.style.display = 'none';
    progressSection.style.display = 'block';
    
    try {
        const response = await fetch('/api/trends/generate-video', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                audio_url: window.generatedAudioUrl,
                avatar_id: avatarId,
                video_format: videoFormat
            })
        });
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –æ—Ç–≤–µ—Ç–∞
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('‚ùå –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON:', text.substring(0, 200));
            throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON –æ—Ç–≤–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞.');
        }
        
        const data = await response.json();
        
        if (data.success) {
            if (data.video_url) {
                // –ï—Å–ª–∏ —Å—Ä–∞–∑—É –ø–æ–ª—É—á–∏–ª–∏ URL (fallback) - –ù–ï –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å
                console.log('‚ö†Ô∏è –ü–æ–ª—É—á–µ–Ω –ø—Ä—è–º–æ–π URL –≤–º–µ—Å—Ç–æ video_id - —ç—Ç–æ fallback!');
                showVideoResult(data.video_url);
            } else if (data.video_id) {
                // –ó–∞–ø—É—Å–∫–∞–µ–º polling —Å—Ç–∞—Ç—É—Å–∞ - –≠–¢–û –ü–†–ê–í–ò–õ–¨–ù–´–ô –ü–£–¢–¨
                console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω video_id, –∑–∞–ø—É—Å–∫–∞–µ–º polling:', data.video_id);
                window.currentVideoId = data.video_id;
                startVideoPolling();
            } else {
                throw new Error('–ù–µ –ø–æ–ª—É—á–µ–Ω –Ω–∏ video_id, –Ω–∏ video_url');
            }
        } else {
            throw new Error(data.message || '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ');
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ:', error);
        showVideoError(error.message);
    }
}

async function useTestVideo() {
    console.log('üß™ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ –≤–∏–¥–µ–æ HeyGen...');
    
    try {
        const response = await fetch('/api/trends/test-video-url');
        const data = await response.json();
        
        if (data.success) {
            console.log('‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', data.video_url);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º URL –≤–∏–¥–µ–æ
            window.generatedVideoUrl = data.video_url;
            window.generatedVideoId = data.video_id;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–∞–∫ –±—É–¥—Ç–æ –≤–∏–¥–µ–æ —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ
            showVideoResult(data.video_url);
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—É–±—Ç–∏—Ç—Ä–æ–≤
            const addCaptionsBtn = document.getElementById('addCaptionsBtn');
            if (addCaptionsBtn) {
                addCaptionsBtn.disabled = false;
                addCaptionsBtn.classList.remove('btn-secondary');
                addCaptionsBtn.classList.add('btn-success');
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            alert('–¢–µ—Å—Ç–æ–≤–æ–µ –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ! –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å—É–±—Ç–∏—Ç—Ä—ã.');
            
        } else {
            throw new Error(data.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –≤–∏–¥–µ–æ');
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –≤–∏–¥–µ–æ:', error);
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –≤–∏–¥–µ–æ: ' + error.message);
    }
}

function startVideoPolling() {
    console.log('‚è≥ –ó–∞–ø—É—Å–∫–∞–µ–º polling —Å—Ç–∞—Ç—É—Å–∞ –≤–∏–¥–µ–æ...');
    let progress = 0;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
    const progressInterval = setInterval(() => {
        progress = Math.min(progress + 2, 90); // –ú–∞–∫—Å–∏–º—É–º 90% –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        updateVideoProgress(progress, '–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ...');
    }, 2000);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
    window.videoPollingInterval = setInterval(async () => {
        try {
            const response = await fetch(`/api/trends/video-status/${window.currentVideoId}`);
            const data = await response.json();
            
            if (data.success) {
                const status = data.status;
                console.log('üìä –°—Ç–∞—Ç—É—Å –≤–∏–¥–µ–æ:', status);
                
                if (status === 'completed') {
                    clearInterval(progressInterval);
                    clearInterval(window.videoPollingInterval);
                    updateVideoProgress(100, '–í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ!');
                    showVideoResult(data.video_url);
                } else if (status === 'failed') {
                    clearInterval(progressInterval);
                    clearInterval(window.videoPollingInterval);
                    showVideoError(data.error || '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ –Ω–µ —É–¥–∞–ª–∞—Å—å');
                } else {
                    // pending, processing, waiting
                    updateVideoProgress(progress, `–°—Ç–∞—Ç—É—Å: ${status}...`);
                }
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
        }
    }, 10000);
    
    // –¢–∞–π–º–∞—É—Ç —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç
    setTimeout(() => {
        if (window.videoPollingInterval) {
            clearInterval(progressInterval);
            clearInterval(window.videoPollingInterval);
            showVideoError('–¢–∞–π–º–∞—É—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ (10 –º–∏–Ω—É—Ç)');
        }
    }, 600000);
}

function updateVideoProgress(percent, text) {
    const progressBar = document.getElementById('videoProgressBar');
    const progressText = document.getElementById('videoProgressText');
    
    progressBar.style.width = `${percent}%`;
    progressBar.setAttribute('aria-valuenow', percent);
    progressText.textContent = text;
}

function showVideoResult(videoUrl) {
    console.log('‚úÖ –í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ:', videoUrl);
    
    // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    document.getElementById('videoProgressSection').style.display = 'none';
    document.getElementById('videoResultSection').style.display = 'block';
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –≤–∏–¥–µ–æ
    const videoElement = document.getElementById('generatedVideo');
    const videoSource = document.getElementById('videoSource');
    videoSource.src = videoUrl;
    videoElement.load();
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º URL –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    window.generatedVideoUrl = videoUrl;
}

function showVideoError(message) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –≤–∏–¥–µ–æ:', message);
    
    // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    document.getElementById('videoProgressSection').style.display = 'none';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
    const settingsSection = document.getElementById('videoSettingsSection');
    settingsSection.innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ:</strong> ${message}
        </div>
        <button class="btn btn-outline-secondary" onclick="resetVideoGeneration()">
            <i class="fas fa-redo me-2"></i>–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
        </button>
    `;
    settingsSection.style.display = 'block';
}

function downloadVideo() {
    if (window.generatedVideoUrl) {
        const link = document.createElement('a');
        link.href = window.generatedVideoUrl;
        link.download = `video_${Date.now()}.mp4`;
        link.click();
    }
}

function resetVideoGeneration() {
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    window.currentVideoId = null;
    window.generatedVideoUrl = null;
    
    if (window.videoPollingInterval) {
        clearInterval(window.videoPollingInterval);
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, —Å–∫—Ä—ã–≤–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω–æ–µ
    document.getElementById('videoSettingsSection').style.display = 'block';
    document.getElementById('videoProgressSection').style.display = 'none';
    document.getElementById('videoResultSection').style.display = 'none';
    
    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∞–≤–∞—Ç–∞—Ä—ã
    loadAvatars();
}

// –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è generateVideo —É–¥–∞–ª–µ–Ω–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–æ–≤–∞—è async –≤–µ—Ä—Å–∏—è –≤—ã—à–µ

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (–∑–∞–≥–ª—É—à–∫–∏)
function sortByViews() {
    console.log('üìä –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞–º');
    // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
}

function sortByLikes() {
    console.log('üìä –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –ª–∞–π–∫–∞–º');
    // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
}

// –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤');
    loadCompetitors();
});
// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–º
function copyTranscript() {
    const textarea = document.getElementById('transcriptText');
    textarea.select();
    document.execCommand('copy');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check me-1"></i>–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
    button.classList.remove('btn-outline-primary');
    button.classList.add('btn-success');
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-primary');
    }, 2000);
}

function clearTranscript() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç?')) {
        document.getElementById('transcriptText').value = '';
    }
}

function saveTranscript() {
    const transcript = document.getElementById('transcriptText').value;
    window.transcriptText = transcript;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check me-1"></i>–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!';
    button.classList.remove('btn-outline-success');
    button.classList.add('btn-success');
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-success');
    }, 2000);
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
document.addEventListener('DOMContentLoaded', function() {
    const transcriptTextarea = document.getElementById('transcriptText');
    if (transcriptTextarea) {
        transcriptTextarea.addEventListener('input', function() {
            window.transcriptText = this.value;
        });
    }
    
    // Live update –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –æ–∑–≤—É—á–∫–∏
    const editableTextarea = document.getElementById('editableText');
    if (editableTextarea) {
        editableTextarea.addEventListener('input', updateTextStats);
    }
});

</script>

<style>
    /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –±–ª–æ–∫–æ–≤-—à–∞–≥–æ–≤ */
    .progress-step {
        margin-bottom: 30px !important;
        box-shadow: 0 8px 32px rgba(0, 64, 39, 0.12) !important;
        border-radius: 16px !important;
        border: 1px solid rgba(0, 64, 39, 0.08) !important;
        transition: all 0.3s ease !important;
    }
    
    .progress-step:hover {
        box-shadow: 0 12px 40px rgba(0, 64, 39, 0.18) !important;
        transform: translateY(-2px) !important;
    }
    
    .progress-step.step-active {
        border-color: var(--gsr-accent) !important;
        box-shadow: 0 8px 32px rgba(39, 145, 52, 0.15) !important;
    }
    
    /* –û—Ç—Å—Ç—É–ø—ã –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
    .step-container {
        padding: 0 15px;
        margin-top: 40px; /* –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –∑–µ–ª–µ–Ω–æ–π –ø–ª–∞—à–∫–æ–π –∏ –±–ª–æ–∫–∞–º–∏ */
    }
    
    /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–æ–≤ */
    .progress-step .card-body,
    .progress-step {
        padding: 30px !important;
    }
    
    /* –ö—Ä–∞—Å–∏–≤—ã–µ —Ç–µ–Ω–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
    .btn-gsr-accent {
        box-shadow: 0 4px 16px rgba(39, 145, 52, 0.3) !important;
        transition: all 0.3s ease !important;
    }
    
    .btn-gsr-accent:hover {
        box-shadow: 0 6px 20px rgba(39, 145, 52, 0.4) !important;
        transform: translateY(-1px) !important;
    }
    
    /* –£–ª—É—á—à–µ–Ω–Ω—ã–π –ª–æ–≥–æ—Ç–∏–ø GSR */
    .gsr-logo {
        height: 90px !important;
        width: 90px !important;
        border-radius: 50% !important;
        background: rgba(255, 255, 255, 0.15) !important;
        padding: 18px !important;
        box-shadow: 0 6px 20px rgba(255, 255, 255, 0.25) !important;
        transition: all 0.3s ease !important;
        border: 2px solid rgba(255, 255, 255, 0.3) !important;
        object-fit: contain !important;
    }
    
    .gsr-logo:hover {
        transform: scale(1.08) !important;
        box-shadow: 0 8px 25px rgba(255, 255, 255, 0.4) !important;
        border-color: rgba(255, 255, 255, 0.5) !important;
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞ */
    .gsr-logo {
        animation: logoGlow 2s ease-in-out infinite alternate !important;
    }
    
    @keyframes logoGlow {
        0% { box-shadow: 0 6px 20px rgba(255, 255, 255, 0.25); }
        100% { box-shadow: 0 8px 25px rgba(255, 255, 255, 0.35); }
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è Excel-—Ç–∞–±–ª–∏—Ü—ã */
    .table-responsive {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .table thead th {
        background-color: #343a40 !important;
        color: white !important;
        border-color: #495057 !important;
        font-weight: 600;
        font-size: 13px;
        padding: 8px 12px;
    }
    
    .table tbody tr {
        transition: background-color 0.2s ease;
    }
    
    .table tbody tr:hover {
        background-color: #f8f9fa !important;
    }
    
    .table tbody td {
        padding: 8px 12px;
        vertical-align: middle;
        border-color: #dee2e6;
    }
    
    .form-check-input {
        margin: 0;
    }
    
    /* –°–∫—Ä—ã—Ç–∏–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö —à–∞–≥–æ–≤ */
    .progress-step.step-disabled {
        display: none !important;
    }
    
    .progress-step.step-active {
        display: block !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card-gsr">
            <div class="card-body text-center gsr-bg-gradient text-white" style="border-radius: 16px 16px 0 0;">
                <img src="/static/7411193.png" alt="GSR" class="gsr-logo mb-3">
                <h1 class="gsr-heading mb-2">
                    <i class="fas fa-chart-line me-2"></i>–ú–æ–¥—É–ª—å –¢—Ä–µ–Ω–¥–≤–æ—Ç—á–∏–Ω–≥–∞
                </h1>
                <p class="mb-0 fs-5">–ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–æ–≤ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—É—Å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤</p>
                <a href="{{ url_for('settings_page', module_name='trends') }}" class="btn btn-outline-light btn-lg mt-3">
                    <i class="fas fa-cog me-2"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ API
                </a>
            </div>
                </div>
                </div>
            </div>

<div class="row step-container">
    <div class="col-12">
        <div class="card-gsr progress-step step-active" id="step1">
            <div class="d-flex align-items-center mb-4">
                    <div class="step-number-gsr">1</div>
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center mb-2">
                        <img src="/static/7411193.png" alt="GSR" class="gsr-logo me-3" style="height: 40px; width: 40px; border-radius: 50%; background: rgba(0, 64, 39, 0.1); padding: 8px;">
                        <h4 class="gsr-heading mb-0 gsr-text-primary">–°–±–æ—Ä —Ä–∏–ª—Å–æ–≤</h4>
            </div>
                    <p class="text-muted mb-0">–£–∫–∞–∂–∏—Ç–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –∏ –ª–∏–º–∏—Ç, —á—Ç–æ–±—ã —Å–æ–±—Ä–∞—Ç—å —Å–≤–µ–∂–∏–µ —Ä–∏–ª—Å—ã</p>
                </div>
                </div>
                
            <div class="mb-4">
                <label for="reelsCount" class="form-label fw-bold gsr-text-secondary">
                        <i class="fas fa-hashtag me-2"></i>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∏–ª—Å–æ–≤ –Ω–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞
                    </label>
                <select class="form-select form-select-lg" id="reelsCount" 
                        style="border: 2px solid rgba(0, 64, 39, 0.2); border-radius: 12px;">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="30">30</option>
                        <option value="50">50</option>
                    </select>
                </div>
            
            <div class="mb-4">
                <label for="dataSource" class="form-label fw-bold gsr-text-secondary">
                    <i class="fas fa-database me-2"></i>–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö
                </label>
                <select class="form-select form-select-lg" id="dataSource" 
                        style="border: 2px solid rgba(0, 64, 39, 0.2); border-radius: 12px;">
                    <option value="apify" selected>Apify (–±—ã—Å—Ç—Ä–æ, –±–∞–∑–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)</option>
                    <option value="phantombuster">PhantomBuster (–º–µ–¥–ª–µ–Ω–Ω–æ, –ø–æ–ª–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)</option>
                </select>
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    PhantomBuster —Å–æ–±–∏—Ä–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –ª–∞–π–∫–∏, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä—ã, –Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –º–µ–¥–ª–µ–Ω–Ω–µ–µ
                </small>
            </div>
            
            <div class="mb-4">
                <label class="form-label fw-bold gsr-text-secondary">
                        <i class="fas fa-users me-2"></i>–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
                    </label>
                <div id="competitorsList" class="p-3 border rounded bg-light" style="max-height: 200px; overflow-y: auto;">
                        <div class="text-center text-muted">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            <div class="mt-2">–ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤‚Ä¶</div>
                        </div>
                    </div>
                    <div class="mt-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="loadCompetitors()">
                        <i class="fas fa-refresh me-1"></i>–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
                    </button>
                </div>
                <div class="mt-2">
                    <small class="text-muted">
                        <span id="competitorsCount">0</span> –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
                    </small>
                </div>
                <div class="form-text mt-2">
                    <a href="{{ url_for('settings_page', module_name='trends') }}" class="link-success">
                        <i class="fas fa-cog me-1"></i>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
                        </a>
                    </div>
                </div>
                
            <button class="btn btn-gsr-accent btn-lg" id="collectButton" onclick="collectReels(event)">
                <i class="fas fa-cloud-download-alt me-2"></i>–°–æ–±—Ä–∞—Ç—å —Ä–∏–ª—Å—ã –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
            </button>
            
            <div id="collectStatus" class="mt-3"></div>
                        </div>
                    </div>
                        </div>

<!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ —à–∞–≥–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
<div class="row step-container">
    <div class="col-12">
        <div class="card-gsr progress-step step-active" id="step2">
            <div class="d-flex align-items-center mb-4">
                <div class="step-number-gsr">2</div>
                <div>
                    <h4 class="gsr-heading mb-1 gsr-text-primary">–û—Ç–±–æ—Ä —Ä–∏–ª—Å–æ–≤</h4>
                    <p class="text-muted mb-0">–í—ã–±–µ—Ä–∏—Ç–µ –ª—É—á—à–∏–π —Ä–∏–ª—Å –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏</p>
                    </div>
                        </div>
            
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <div class="d-flex align-items-center justify-content-between p-3 bg-light border rounded">
                        <span class="fw-bold">–í—Å–µ–≥–æ:</span>
                        <span class="badge bg-primary fs-6" id="totalReels">0</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex align-items-center justify-content-between p-3 bg-light border rounded">
                        <span class="fw-bold">–í—Å–µ–≥–æ —Å–æ–±—Ä–∞–Ω–æ:</span>
                        <span class="badge bg-primary fs-6" id="viralReels">0</span>
            </div>
                </div>
            </div>
            
            <div class="d-flex gap-2 mb-3">
                <button class="btn btn-outline-primary" onclick="sortByViews()">
                    <i class="fas fa-eye me-1"></i>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã
                </button>
                <button class="btn btn-outline-danger" onclick="sortByLikes()">
                    <i class="fas fa-heart me-1"></i>–õ–∞–π–∫–∏
                </button>
            </div>
            
            <div id="reelsList" class="row g-3">
                <div class="col-12 text-center text-muted p-4">
                    <i class="fas fa-video fa-2x mb-2"></i>
                    <div>–°–Ω–∞—á–∞–ª–∞ —Å–æ–±–µ—Ä–∏—Ç–µ —Ä–∏–ª—Å—ã –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –®–∞–≥ 3: –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è -->
<div class="row step-container">
    <div class="col-12">
        <div class="card-gsr progress-step step-disabled" id="step3">
            <div class="d-flex align-items-center mb-4">
                <div class="step-number-gsr">3</div>
                <div>
                    <h4 class="gsr-heading mb-1 gsr-text-primary">–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è</h4>
                    <p class="text-muted mb-0">–ò–∑–≤–ª–µ–∫–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–∏–ª—Å–∞</p>
                </div>
            </div>
            
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ä–∏–ª—Å–µ -->
            <div id="selectedReelInfo" class="mb-4" style="display: none;">
                <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ä–∏–ª—Å–µ -->
            </div>
            
            <div class="mb-4">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    –í—ã–±–µ—Ä–∏—Ç–µ —Ä–∏–ª—Å –Ω–∞ —à–∞–≥–µ 2, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏
                </div>
            </div>
            
            <button class="btn btn-gsr-accent btn-lg" onclick="transcribeSelectedReel()">
                <i class="fas fa-microphone me-2"></i>–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞—Ç—å —Ä–∏–ª—Å
            </button>
            
            <div id="transcribeStatus" class="mt-3"></div>
            
            <div id="transcriptResult" class="mt-4" style="display: none;">
                <h5 class="gsr-text-primary">–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏:</h5>
                <div class="p-3 bg-light border rounded">
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-edit me-2"></i>–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ –ò–ò:
                        </label>
                        <textarea id="transcriptText" class="form-control" rows="6" 
                                  placeholder="–ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç..."></textarea>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            –í—ã –º–æ–∂–µ—Ç–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏–µ–º
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="copyTranscript()">
                            <i class="fas fa-copy me-1"></i>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="clearTranscript()">
                            <i class="fas fa-eraser me-1"></i>–û—á–∏—Å—Ç–∏—Ç—å
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="saveTranscript()">
                            <i class="fas fa-save me-1"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –®–∞–≥ 4: –ü–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ -->
<div class="row step-container">
    <div class="col-12">
        <div class="card-gsr progress-step step-disabled" id="step4">
            <div class="d-flex align-items-center mb-4">
                <div class="step-number-gsr">4</div>
                <div>
                    <h4 class="gsr-heading mb-1 gsr-text-primary">–ü–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏–µ</h4>
                    <p class="text-muted mb-0">–£–ª—É—á—à–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å –ø–æ–º–æ—â—å—é –ò–ò</p>
                </div>
            </div>
            
            <div class="mb-4">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—é –Ω–∞ —à–∞–≥–µ 3
                </div>
            </div>
            
            <button class="btn btn-gsr-accent btn-lg" onclick="rewriteTranscript()">
                <i class="fas fa-edit me-2"></i>–ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç
            </button>
            
            <div id="rewriteStatus" class="mt-3"></div>
            
            <div id="rewrittenResult" class="mt-4" style="display: none;">
                <h5 class="gsr-text-primary">–£–ª—É—á—à–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:</h5>
                <div class="p-3 bg-light border rounded">
                    <p id="rewrittenText" class="mb-0"></p>
            </div>
            </div>
        </div>
    </div>
                </div>
                
<!-- –®–∞–≥ 5: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—É–¥–∏–æ -->
<div class="row step-container">
    <div class="col-12">
        <div class="card-gsr progress-step step-disabled" id="step5">
            <div class="d-flex align-items-center mb-4">
                <div class="step-number-gsr">5</div>
                <div>
                    <h4 class="gsr-heading mb-1 gsr-text-primary">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—É–¥–∏–æ</h4>
                    <p class="text-muted mb-0">–°–æ–∑–¥–∞–π—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ</p>
                        </div>
            </div>
            
            <div class="mb-4">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    –°–Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞ —à–∞–≥–µ 4
                    </div>
                </div>
                
            <!-- –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π —Ç–µ–∫—Å—Ç -->
            <div class="mb-4">
                <label for="editableText" class="form-label">–¢–µ–∫—Å—Ç –¥–ª—è –æ–∑–≤—É—á–∫–∏</label>
                <textarea 
                    class="form-control" 
                    id="editableText" 
                    rows="4" 
                    placeholder="–ü–µ—Ä–µ–ø–∏—Å–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å..."
                ></textarea>
                <div class="form-text" id="textStats">
                    –°–∏–º–≤–æ–ª–æ–≤: 0 | –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è: ~0 —Å–µ–∫
                </div>
            </div>
                
            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–æ–ª–æ—Å–∞ -->
            <div class="mb-4">
                <h5 class="gsr-text-primary mb-3">
                    <i class="fas fa-cog me-2"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–æ–ª–æ—Å–∞
                </h5>
                
                <div class="row">
                    <!-- –ì–æ–ª–æ—Å -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label">–ì–æ–ª–æ—Å</label>
                        <select class="form-select" id="voiceSelect">
                            <option value="jP9L6ZC55cz5mmx4ZpCk" selected>‚úÖ –ê—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫–∏–π –ê–ª–µ–∫—Å–µ–π (–†—É—Å—Å–∫–∏–π)</option>
                            <option value="JBFqnCBsd6RMkjVDRZzb">Rachel (Female, American)</option>
                            <option value="EXAVITQu4vr4xnSDxMaL">Bella (Female, American)</option>
                            <option value="VR6AewLTigWG4xSOukaG">Josh (Male, American)</option>
                        </select>
                    </div>
                    
                    <!-- –ú–æ–¥–µ–ª—å -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label">–ú–æ–¥–µ–ª—å</label>
                        <select class="form-select" id="modelSelect">
                            <option value="eleven_flash_v2_5" selected>‚úÖ Eleven Flash v2.5 (–ë—ã—Å—Ç—Ä—ã–π)</option>
                            <option value="eleven_multilingual_v2">Eleven Multilingual v2</option>
                            <option value="eleven_turbo_v2_5">Eleven Turbo v2.5</option>
                        </select>
                    </div>
                </div>
                
                <!-- –ü–æ–ª–∑—É–Ω–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å: <span id="stabilityValue">0.5</span></label>
                        <input type="range" class="form-range" id="stabilitySlider" 
                               min="0.0" max="1.0" step="0.1" value="0.5"
                               oninput="document.getElementById('stabilityValue').textContent = this.value">
                        <small class="text-muted">–ß–µ–º –≤—ã—à–µ, —Ç–µ–º —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ –≥–æ–ª–æ—Å</small>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label class="form-label">–°—Ö–æ–∂–µ—Å—Ç—å: <span id="similarityValue">0.5</span></label>
                        <input type="range" class="form-range" id="similaritySlider" 
                               min="0.0" max="1.0" step="0.1" value="0.5"
                               oninput="document.getElementById('similarityValue').textContent = this.value">
                        <small class="text-muted">–°—Ö–æ–∂–µ—Å—Ç—å —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º –≥–æ–ª–æ—Å–æ–º</small>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label class="form-label">–°–∫–æ—Ä–æ—Å—Ç—å: <span id="speedValue">1.0</span></label>
                        <input type="range" class="form-range" id="speedSlider" 
                               min="0.5" max="2.0" step="0.1" value="1.0"
                               oninput="document.getElementById('speedValue').textContent = this.value">
                        <small class="text-muted">–°–∫–æ—Ä–æ—Å—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è (0.5x - 2.0x)</small>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">
                            <input type="checkbox" id="useAdvanced" class="form-check-input me-2">
                            –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                        </label>
                        <small class="text-muted d-block">–ü—Ä–∏–º–µ–Ω–∏—Ç—å stability –∏ similarity</small>
                    </div>
                    </div>
                </div>
                
            <button class="btn btn-gsr-accent btn-lg" onclick="generateAudio()">
                <i class="fas fa-volume-up me-2"></i>–°–æ–∑–¥–∞—Ç—å –∞—É–¥–∏–æ
            </button>
            
            <div id="audioStatus" class="mt-3"></div>
            
            <div id="audioResult" class="mt-4" style="display: none;">
                <h5 class="gsr-text-primary">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∞—É–¥–∏–æ:</h5>
                <audio id="audioPlayer" controls crossorigin playsinline>
                    <source id="audioSource" src="" type="audio/mpeg">
                </audio>
                        </div>
                    </div>
                        </div>
                    </div>

<!-- –®–∞–≥ 6: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ -->
<div class="row step-container">
    <div class="col-12">
        <div class="card-gsr progress-step step-disabled" id="step6">
            <div class="d-flex align-items-center mb-4">
                <div class="step-number-gsr">6</div>
                <div>
                    <h4 class="gsr-heading mb-1 gsr-text-primary">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ</h4>
                    <p class="text-muted mb-0">–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ —Å –∞–≤–∞—Ç–∞—Ä–æ–º</p>
                        </div>
                    </div>
            
            <!-- –°–µ–∫—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –î–û –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -->
            <div id="videoSettingsSection">
            <div class="mb-4">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∞—É–¥–∏–æ –Ω–∞ —à–∞–≥–µ 5
                </div>
            </div>
            
                <!-- –í—ã–±–æ—Ä –∞–≤–∞—Ç–∞—Ä–∞ -->
                <div class="mb-4">
                    <h5 class="gsr-text-primary mb-3">
                        <i class="fas fa-user-circle me-2"></i>–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä
                    </h5>
                    <select id="avatarSelect" class="form-select mb-3">
                        <option value="">–ó–∞–≥—Ä—É–∂–∞–µ–º –∞–≤–∞—Ç–∞—Ä—ã...</option>
                    </select>
                    <div id="avatarPreview" class="text-center">
                        <img id="avatarPreviewImg" src="" alt="Avatar Preview" class="img-thumbnail" 
                             style="max-width: 200px; max-height: 200px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); display: none;">
                        <div id="avatarPreviewPlaceholder" class="text-muted" style="display: block;">
                            <i class="fas fa-user-circle fa-3x mb-2"></i>
                            <p>–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞</p>
                        </div>
                    </div>
                </div>
                
                <!-- –û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –≤–∏–¥–µ–æ -->
                <div class="mb-4">
                    <h5 class="gsr-text-primary mb-3">
                        <i class="fas fa-mobile-alt me-2"></i>–û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –≤–∏–¥–µ–æ
                    </h5>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="videoOrientation" id="vertical" value="vertical" checked>
                        <label class="btn btn-outline-primary" for="vertical">
                            <i class="fas fa-mobile-alt me-2"></i>–ü–æ—Ä—Ç—Ä–µ—Ç (9:16)
                        </label>
                        
                        <input type="radio" class="btn-check" name="videoOrientation" id="horizontal" value="horizontal">
                        <label class="btn btn-outline-primary" for="horizontal">
                            <i class="fas fa-desktop me-2"></i>–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è (16:9)
                        </label>
                    </div>
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -->
                <button class="btn btn-gsr-accent btn-lg w-100" onclick="generateVideo()">
                    <i class="fas fa-video me-2"></i>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –í–∏–¥–µ–æ
                </button>
            
                <!-- –ö–Ω–æ–ø–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –≤–∏–¥–µ–æ -->
                <button id="useTestVideoBtn" class="btn btn-warning btn-lg w-100 mt-2" onclick="useTestVideo()">
                    <i class="fas fa-flask me-2"></i>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¢–µ—Å—Ç–æ–≤–æ–µ –í–∏–¥–µ–æ (–±–µ–∑ –∑–∞—Ç—Ä–∞—Ç HeyGen)
                </button>
            </div>
            
            <!-- –°–µ–∫—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -->
            <div id="videoProgressSection" style="display: none;">
                <div class="alert alert-warning">
                    <i class="fas fa-clock me-2"></i>
                    <strong>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ –∑–∞–π–º–µ—Ç 7-10 –º–∏–Ω—É—Ç</strong>
                </div>
                <div class="progress mb-3" style="height: 25px;">
                    <div id="videoProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width: 0%"></div>
                </div>
                <p id="videoProgressText" class="text-center">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</p>
            </div>
            
            <!-- –°–µ–∫—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
            <div id="videoResultSection" style="display: none;">
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>–í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ!</strong>
                </div>
                <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –¥–ª—è Submagic -->
                <div id="submagicProgressContainer" style="display: none;">
                    <div class="alert alert-info">
                        <i class="fas fa-magic me-2"></i>
                        –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—É–±—Ç–∏—Ç—Ä–æ–≤ –∏ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤: <span id="submagicProgressText">0%</span>
                        <div class="progress mt-2">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="submagicProgressBar" 
                                 role="progressbar" 
                                 style="width: 0%"></div>
                        </div>
                        <small class="text-muted">–ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è: 3-5 –º–∏–Ω—É—Ç</small>
                    </div>
                </div>
                
                <video id="generatedVideo" controls class="w-100 rounded">
                    <source id="videoSource" src="" type="video/mp4">
                    –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç.
                </video>
                <div class="mt-3 text-center">
                    <button onclick="downloadVideo()" class="btn btn-success me-2">
                        <i class="fas fa-download me-2"></i>–°–∫–∞—á–∞—Ç—å –í–∏–¥–µ–æ
                    </button>
                    <button onclick="showCaptionsModal()" class="btn btn-primary me-2">
                        <i class="fas fa-closed-captioning me-2"></i>–î–æ–±–∞–≤–∏—Ç—å —Å—É–±—Ç–∏—Ç—Ä—ã
                    </button>
                    <button onclick="resetVideoGeneration()" class="btn btn-outline-secondary">
                        <i class="fas fa-redo me-2"></i>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∑–∞–¥–∞—á–∏
async function pollTaskStatus(taskId, competitorsCount) {
    console.log('üîÑ –ù–∞—á–∏–Ω–∞–µ–º polling –¥–ª—è –∑–∞–¥–∞—á–∏:', taskId);
    
    const statusDiv = document.getElementById('collectStatus');
    let attempts = 0;
    const maxAttempts = 120; // 10 –º–∏–Ω—É—Ç —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º 5 —Å–µ–∫—É–Ω–¥
    
    const pollInterval = setInterval(async () => {
        attempts++;
        console.log(`üîÑ Polling –ø–æ–ø—ã—Ç–∫–∞ ${attempts}/${maxAttempts} –¥–ª—è –∑–∞–¥–∞—á–∏ ${taskId}`);
        
        try {
            const response = await fetch(`/api/trends/task-status/${taskId}`);
            const status = await response.json();
            
            console.log('üìä –°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏:', status);
            
            if (status.status === 'completed') {
                clearInterval(pollInterval);
                console.log('‚úÖ –ó–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
                
                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        –£—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω–æ ${status.result.total_count || 0} —Ä–∏–ª—Å–æ–≤ –æ—Ç ${competitorsCount} –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
                        <br><small class="text-muted">–í–∏—Ä–∞–ª—å–Ω—ã—Ö: ${status.result.viral_count || 0}</small>
                    </div>`;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥
                window.collectedReelsData = status.result;
                window.collectedReels = status.result.reels;
                displayReels(window.collectedReels);
                activateStep2();
                
            } else if (status.status === 'error') {
                clearInterval(pollInterval);
                console.error('‚ùå –ó–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —Å –æ—à–∏–±–∫–æ–π:', status.message);
                
                statusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∞ —Ä–∏–ª—Å–æ–≤: ${status.message}
                    </div>`;
                    
            } else if (status.status === 'running') {
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                const progress = status.progress || 0;
                statusDiv.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        ${status.message || '–°–±–æ—Ä —Ä–∏–ª—Å–æ–≤ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...'} (${progress}%)
                        <div class="progress mt-2">
                            <div class="progress-bar" style="width: ${progress}%"></div>
                        </div>
                    </div>`;
            }
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ polling:', error);
            if (attempts >= maxAttempts) {
                clearInterval(pollInterval);
                statusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.
                    </div>`;
            }
        }
        
        if (attempts >= maxAttempts) {
            clearInterval(pollInterval);
            console.error('‚ùå –ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ polling');
        }
        
    }, 5000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
}

// –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Plyr –ø–ª–µ–µ—Ä–∞
function initializePlyrPlayer(audioUrl) {
    console.log('üéµ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Plyr –ø–ª–µ–µ—Ä:', audioUrl);
    
    const audioElement = document.getElementById('audioPlayer');
    const audioSource = document.getElementById('audioSource');
    
    // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—Ç–∞—Ä—ã–π –ø–ª–µ–µ—Ä –µ—Å–ª–∏ –µ—Å—Ç—å
    if (window.plyrPlayer) {
        window.plyrPlayer.destroy();
        window.plyrPlayer = null;
    }
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫
    audioSource.src = audioUrl;
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
    audioElement.onloadedmetadata = function() {
        console.log('‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∞—É–¥–∏–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:', audioElement.duration);
        
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π Plyr –ø–ª–µ–µ—Ä –ü–û–°–õ–ï –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
        window.plyrPlayer = new Plyr(audioElement, {
            controls: ['play', 'progress', 'current-time', 'duration', 'volume', 'download'],
            settings: [],
            autoplay: false,
            volume: 0.8
        });
        
        console.log('‚úÖ Plyr –ø–ª–µ–µ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    };
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏
    audioElement.onerror = function(e) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏–æ:', e);
        console.error('–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å:', audioUrl);
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞—É–¥–∏–æ –∑–∞–Ω–æ–≤–æ.');
    };
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—É–¥–∏–æ
    audioElement.load();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ preview –∞–≤–∞—Ç–∞—Ä–∞
function generateAvatarPreview(avatarId, avatarName) {
    // –°–æ–∑–¥–∞–µ–º canvas –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ preview –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const canvas = document.createElement('canvas');
    canvas.width = 200;
    canvas.height = 200;
    const ctx = canvas.getContext('2d');
    
    // –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω
    const gradient = ctx.createLinearGradient(0, 0, 200, 200);
    gradient.addColorStop(0, '#667eea');
    gradient.addColorStop(1, '#764ba2');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, 200, 200);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –∞–≤–∞—Ç–∞—Ä–∞
    ctx.fillStyle = 'white';
    ctx.font = 'bold 60px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    
    // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—É—é –±—É–∫–≤—É –∏–º–µ–Ω–∏ –∏–ª–∏ –∏–Ω–∏—Ü–∏–∞–ª—ã
    const initials = avatarName.split(' ').map(word => word[0]).join('').substring(0, 2);
    ctx.fillText(initials, 100, 80);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–º—è –∞–≤–∞—Ç–∞—Ä–∞
    ctx.font = 'bold 16px Arial';
    ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
    
    // –†–∞–∑–±–∏–≤–∞–µ–º –¥–ª–∏–Ω–Ω–æ–µ –∏–º—è –Ω–∞ —Å—Ç—Ä–æ–∫–∏
    const words = avatarName.split(' ');
    let y = 140;
    words.forEach(word => {
        if (word.length > 12) {
            // –ï—Å–ª–∏ —Å–ª–æ–≤–æ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ, —Ä–∞–∑–±–∏–≤–∞–µ–º –µ–≥–æ
            const chunks = word.match(/.{1,12}/g) || [word];
            chunks.forEach(chunk => {
                ctx.fillText(chunk, 100, y);
                y += 20;
            });
        } else {
            ctx.fillText(word, 100, y);
            y += 20;
        }
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–º–∫—É
    ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
    ctx.lineWidth = 2;
    ctx.strokeRect(1, 1, 198, 198);
    
    return canvas.toDataURL('image/png');
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è Submagic —Å—É–±—Ç–∏—Ç—Ä–æ–≤
function showCaptionsModal() {
    console.log('üé¨ –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å—É–±—Ç–∏—Ç—Ä–æ–≤');
    const modal = document.getElementById('captionsModal');
    if (modal) {
        modal.style.display = 'block';
        loadSubmagicTemplates();
        loadSubmagicLanguages();
    }
}

function updateVideoPlayer(videoUrl) {
    console.log('üé¨ –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–µ–æ –ø–ª–µ–µ—Ä:', videoUrl);
    const videoElement = document.getElementById('generatedVideo');
    const videoSource = document.getElementById('videoSource');
    if (videoElement && videoSource) {
        videoSource.src = videoUrl;
        videoElement.load();
        window.generatedVideoUrl = videoUrl;
    }
}

async function showSubmagicProgress(taskId) {
    console.log('üìä –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å Submagic –¥–ª—è –∑–∞–¥–∞—á–∏:', taskId);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –Ω–∞–¥ –≤–∏–¥–µ–æ –ø–ª–µ–µ—Ä–æ–º
    const progressContainer = document.getElementById('submagicProgressContainer');
    if (progressContainer) {
        progressContainer.style.display = 'block';
    }
    
    // Polling –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥
    const interval = setInterval(async () => {
        try {
            const response = await fetch(`/api/trends/submagic-status/${taskId}`);
            const data = await response.json();
            
            if (data.success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                const progressText = document.getElementById('submagicProgressText');
                const progressBar = document.getElementById('submagicProgressBar');
                
                if (progressText) {
                    progressText.textContent = data.progress + '%';
                }
                if (progressBar) {
                    progressBar.style.width = data.progress + '%';
                }
                
                if (data.status === 'completed') {
                    clearInterval(interval);
                    console.log('‚úÖ Submagic –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞:', data.video_url);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–µ–æ –Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é
                    updateVideoPlayer(data.video_url);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º success —Å–æ–æ–±—â–µ–Ω–∏–µ
                    showSuccessMessage('–°—É–±—Ç–∏—Ç—Ä—ã –∏ —ç—Ñ—Ñ–µ–∫—Ç—ã —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω—ã!');
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
                    if (progressContainer) {
                        progressContainer.style.display = 'none';
                    }
                } else if (data.status === 'error') {
                    clearInterval(interval);
                    console.error('‚ùå –û—à–∏–±–∫–∞ Submagic:', data.error);
                    showErrorMessage('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: ' + data.error);
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
                    if (progressContainer) {
                        progressContainer.style.display = 'none';
                    }
                }
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
        }
    }, 15000);
}

function showSuccessMessage(message) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º success —Å–æ–æ–±—â–µ–Ω–∏–µ
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show';
    alertDiv.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    const container = document.querySelector('.container-fluid');
    if (container) {
        container.insertBefore(alertDiv, container.firstChild);
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
}

function showErrorMessage(message) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º error —Å–æ–æ–±—â–µ–Ω–∏–µ
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger alert-dismissible fade show';
    alertDiv.innerHTML = `
        <i class="fas fa-exclamation-circle me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    const container = document.querySelector('.container-fluid');
    if (container) {
        container.insertBefore(alertDiv, container.firstChild);
    }
}

function closeCaptionsModal() {
    const modal = document.getElementById('captionsModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

async function loadSubmagicTemplates() {
    try {
        const response = await fetch('/api/trends/submagic-templates');
        const data = await response.json();
        
        if (data.success && data.templates) {
            const select = document.getElementById('captionTemplate');
            select.innerHTML = '';
            data.templates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.name || template;
                option.textContent = template.name || template;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à–∞–±–ª–æ–Ω–æ–≤:', error);
    }
}

async function loadSubmagicLanguages() {
    try {
        const response = await fetch('/api/trends/submagic-languages');
        const data = await response.json();
        
        if (data.success && data.languages) {
            const select = document.getElementById('captionLanguage');
            select.innerHTML = '';
            data.languages.forEach(language => {
                const option = document.createElement('option');
                option.value = language.code || language;
                option.textContent = language.name || language;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —è–∑—ã–∫–æ–≤:', error);
    }
}

async function applyCaptions() {
    console.log('üé¨ –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—É–±—Ç–∏—Ç—Ä—ã –∫ –≤–∏–¥–µ–æ');
    
    const videoUrl = window.generatedVideoUrl;
    if (!videoUrl) {
        alert('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –≤–∏–¥–µ–æ');
        return;
    }
    
    // –°–æ–±–∏—Ä–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    const settings = {
        language: document.getElementById('captionLanguage').value,
        template_name: document.getElementById('captionTemplate').value,
        magic_brolls: document.getElementById('enableBrolls').checked,
        brolls_percentage: parseInt(document.getElementById('brollsPercentage').value),
        magic_zooms: document.getElementById('enableZooms').checked,
        background_music: document.getElementById('enableMusic').checked
    };
    
    console.log('‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—É–±—Ç–∏—Ç—Ä–æ–≤:', settings);
    
    try {
        const response = await fetch('/api/trends/add-captions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                video_url: videoUrl,
                settings: settings
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            console.log('‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞:', data.task_id);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ –≤–∏–¥–µ–æ HeyGen
            updateVideoPlayer(data.video_url);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
            showSubmagicProgress(data.task_id);
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ, –Ω–æ –ù–ï –±–ª–æ–∫–∏—Ä—É–µ–º —Ä–∞–±–æ—Ç—É
            closeCaptionsModal();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.message);
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—É–±—Ç–∏—Ç—Ä–æ–≤:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å—É–±—Ç–∏—Ç—Ä–æ–≤');
    }
}

// –û–±–Ω–æ–≤–ª—è–µ–º —Å–ª–∞–π–¥–µ—Ä –ø—Ä–æ—Ü–µ–Ω—Ç–∞ B-rolls
function updateBrollsPercentage() {
    const slider = document.getElementById('brollsPercentage');
    const value = document.getElementById('brollsValue');
    value.textContent = slider.value + '%';
}
</script>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å—É–±—Ç–∏—Ç—Ä–æ–≤ -->
<div id="captionsModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-closed-captioning me-2"></i>–î–æ–±–∞–≤–∏—Ç—å —Å—É–±—Ç–∏—Ç—Ä—ã –∏ —ç—Ñ—Ñ–µ–∫—Ç—ã</h3>
            <span class="close" onclick="closeCaptionsModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="mb-3">
                <label for="captionLanguage" class="form-label">–Ø–∑—ã–∫ —Å—É–±—Ç–∏—Ç—Ä–æ–≤:</label>
                <select id="captionLanguage" class="form-select">
                    <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                    <option value="en">English</option>
                </select>
            </div>
            
            <div class="mb-3">
                <label for="captionTemplate" class="form-label">–®–∞–±–ª–æ–Ω:</label>
                <select id="captionTemplate" class="form-select">
                    <option value="Hormozi 2">Hormozi 2</option>
                </select>
            </div>
            
            <div class="mb-3">
                <label class="form-check-label">
                    <input type="checkbox" id="enableBrolls" class="form-check-input">
                    Magic B-rolls (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–∏–¥–µ–æ–≤—Å—Ç–∞–≤–∫–∏)
                </label>
                <div id="brollsSettings" style="display: none; margin-top: 10px;">
                    <label for="brollsPercentage" class="form-label">–ü—Ä–æ—Ü–µ–Ω—Ç B-rolls:</label>
                    <input type="range" id="brollsPercentage" class="form-range" 
                           min="0" max="100" value="75" oninput="updateBrollsPercentage()">
                    <span id="brollsValue">75%</span>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-check-label">
                    <input type="checkbox" id="enableZooms" class="form-check-input">
                    Magic Zooms (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∑—É–º-—ç—Ñ—Ñ–µ–∫—Ç—ã)
                </label>
            </div>
            
            <div class="mb-3">
                <label class="form-check-label">
                    <input type="checkbox" id="enableMusic" class="form-check-input">
                    –§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeCaptionsModal()">–û—Ç–º–µ–Ω–∞</button>
            <button type="button" class="btn btn-primary" onclick="applyCaptions()">
                <i class="fas fa-magic me-2"></i>–î–æ–±–∞–≤–∏—Ç—å —Å—É–±—Ç–∏—Ç—Ä—ã
            </button>
        </div>
    </div>
</div>

<style>
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 0;
    border: none;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    padding: 20px;
    border-top: 1px solid #dee2e6;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: #000;
}

#brollsSettings {
    transition: all 0.3s ease;
}
</style>

<script>
// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ B-rolls
document.addEventListener('DOMContentLoaded', function() {
    const brollsCheckbox = document.getElementById('enableBrolls');
    const brollsSettings = document.getElementById('brollsSettings');
    
    if (brollsCheckbox && brollsSettings) {
        brollsCheckbox.addEventListener('change', function() {
            brollsSettings.style.display = this.checked ? 'block' : 'none';
        });
    }
});
</script>

{% endblock %}
