{% extends "base.html" %}

{% block title %}Эксперты - Контент Завод{% endblock %}

{% block extra_head %}
<style>
    .topics-table {
        border: 1px solid #e9ecef;
        border-radius: 16px;
        overflow: hidden;
        background: #ffffff;
        box-shadow: 0 8px 32px rgba(0, 64, 39, 0.08);
    }

    .topics-table table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    .topics-table thead {
        background: var(--gsr-gradient-primary);
        color: #ffffff;
    }

    .topics-table th,
    .topics-table td {
        padding: 16px 20px;
        vertical-align: middle;
    }

    .topics-table tbody tr:nth-child(even) {
        background: rgba(0, 64, 39, 0.03);
    }

    .topics-table tbody tr:hover {
        background: rgba(39, 145, 52, 0.08);
    }

    .topic-btn {
        background: linear-gradient(45deg, var(--gsr-accent), #2e7d32);
        color: #fff;
        border: none;
        border-radius: 50px;
        padding: 10px 20px;
        font-weight: 600;
        transition: transform 0.2s ease;
    }

    .topic-btn:hover {
        transform: translateY(-2px);
        color: #fff;
    }

    .topic-category {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        background: rgba(39, 145, 52, 0.12);
        color: var(--gsr-primary);
        font-weight: 600;
        font-size: 0.85rem;
    }

    .topic-category.young {
        background: rgba(0, 123, 255, 0.12);
        color: #0b5ed7;
    }

    .topic-category.middle {
        background: rgba(235, 128, 0, 0.12);
        color: #d87000;
    }

    .topic-category.senior {
        background: rgba(111, 66, 193, 0.12);
        color: #6f42c1;
    }

    .topic-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--gsr-gradient-accent);
        color: #fff;
        font-weight: 700;
    }
</style>
{% endblock %}


{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card-gsr">
            <div class="card-body text-center gsr-bg-gradient text-white" style="border-radius: 16px 16px 0 0;">
                <img src="/static/7411193.png" alt="GSR" class="gsr-logo mb-3">
                <h1 class="gsr-heading mb-2">
                    <i class="fas fa-user-graduate me-2"></i>Модуль Эксперты
                </h1>
                <p class="mb-0 fs-5">Создание экспертного видео-контента на основе тем от ИИ</p>
                <a href="{{ url_for('settings_page', module_name='experts') }}" class="btn btn-outline-light btn-lg mt-3">
                    <i class="fas fa-cog me-2"></i>Настройки
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card-gsr progress-step step-active" id="step1">
            <div class="d-flex align-items-center mb-4">
                <div class="step-number-gsr">1</div>
                <div>
                    <h4 class="gsr-heading mb-1 gsr-text-primary">Генерация тем</h4>
                    <p class="text-muted mb-0">Получите 30 актуальных тем от ИИ-ассистента</p>
                </div>
            </div>

            <div class="row g-4 align-items-center">
                <div class="col-lg-8">
                    <div class="p-4 bg-light border rounded-3 h-100">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-lightbulb text-warning me-3 fs-3"></i>
                            <div>
                                <h5 class="mb-2">ИИ-анализ вашей ниши</h5>
                                <p class="mb-0 text-muted">
                                    Ассистент изучит заданный портрет потребителя и предложит выдающие идеи для роликов.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 text-lg-end text-center">
                    <button type="button" class="btn btn-gsr-accent btn-lg px-5 py-3" onclick="generateTopics()">
                        <i class="fas fa-magic me-2"></i>Сгенерировать 30 тем
                    </button>
                </div>
            </div>

            <div id="topicsStatus" class="mt-3"></div>
        </div>
    </div>
</div>

<div class="row" id="step2">
    <div class="col-12">
        <div class="card-gsr progress-step step-disabled">
            <div class="d-flex align-items-center mb-4">
                <div class="step-number-gsr">2</div>
                <div>
                    <h4 class="gsr-heading mb-1 gsr-text-primary">Выбор темы</h4>
                    <p class="text-muted mb-0">Выберите тему, которая лучше всего подходит вашей аудитории</p>
                </div>
            </div>

            <div id="topicsList" class="topics-table"></div>
        </div>
    </div>
</div>

<div class="row" id="step3">
    <div class="col-12">
        <div class="card-gsr progress-step step-disabled">
            <div class="d-flex align-items-center mb-4">
                <div class="step-number-gsr">3</div>
                <div>
                    <h4 class="gsr-heading mb-1 gsr-text-primary">Редактирование текста</h4>
                    <p class="text-muted mb-0">Отредактируйте сгенерированный текст перед озвучкой</p>
                </div>
            </div>

            <div id="textStatus" class="mb-3"></div>

            <label class="form-label fw-bold gsr-text-secondary" for="generatedText">
                <i class="fas fa-edit me-2"></i>Текст для видео (40-60 секунд)
            </label>
            <textarea class="form-control text-editor" id="generatedText" placeholder="Здесь появится сгенерированный текст..."></textarea>
            <div class="form-text mt-2">
                <i class="fas fa-info-circle me-1 text-info"></i>Рекомендуемая длительность: 120-150 слов.
            </div>

            <div class="d-flex flex-column flex-md-row gap-3 justify-content-center mt-4">
                <button type="button" class="btn btn-gsr-accent btn-lg px-4" onclick="generateAudio()">
                    <i class="fas fa-microphone me-2"></i>Создать аудиодорожку
                </button>
                <button type="button" class="btn btn-outline-secondary btn-lg px-4" onclick="backToTopics()">
                    <i class="fas fa-arrow-left me-2"></i>Назад к списку тем
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row" id="step4">
    <div class="col-12">
        <div class="card-gsr progress-step step-disabled">
            <div class="d-flex align-items-center mb-4">
                <div class="step-number-gsr">4</div>
                <div>
                    <h4 class="gsr-heading mb-1 gsr-text-primary">Аудиодорожка</h4>
                    <p class="text-muted mb-0">Настройте голос и прослушайте результат</p>
                </div>
            </div>

            <div id="audioStatus" class="mb-3"></div>

            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <label class="form-label fw-bold gsr-text-secondary">
                        <i class="fas fa-robot me-2"></i>Модель ElevenLabs
                    </label>
                    <select class="form-select" id="audioModel">
                        <option value="eleven_multilingual_v2">Eleven Multilingual v2 (Рекомендуется)</option>
                        <option value="eleven_flash_v2_5">Eleven Flash v2.5 (Быстрая)</option>
                        <option value="eleven_turbo_v2_5">Eleven Turbo v2.5 (Сбалансированная)</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold gsr-text-secondary">
                        <i class="fas fa-microphone me-2"></i>Голос
                    </label>
                    <select class="form-select" id="audioVoice">
                        <option value="JBFqnCBsd6RMkjVDRZzb">По умолчанию</option>
                    </select>
                </div>
            </div>

            <div id="audioPlayer" class="mb-4" style="display: none;">
                <audio controls class="w-100 mb-3">
                    <source id="audioSource" type="audio/mpeg">
                    Ваш браузер не поддерживает аудио элемент.
                </audio>
            </div>

            <div class="d-flex flex-column flex-md-row gap-3 justify-content-center">
                <button type="button" class="btn btn-gsr-accent btn-lg px-4" onclick="generateVideo()" id="generateVideoBtn" style="display: none;">
                    <i class="fas fa-video me-2"></i>Создать видео в HeyGen
                </button>
                <button type="button" class="btn btn-outline-secondary btn-lg px-4" onclick="backToText()">
                    <i class="fas fa-arrow-left me-2"></i>Изменить текст
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row" id="step5">
    <div class="col-12">
        <div class="card-gsr progress-step step-disabled">
            <div class="d-flex align-items-center mb-4">
                <div class="step-number-gsr">5</div>
                <div>
                    <h4 class="gsr-heading mb-1 gsr-text-primary">Готовое видео</h4>
                    <p class="text-muted mb-0">Скачайте экспертный ролик и поделитесь с аудиторией</p>
                </div>
            </div>

            <div id="videoStatus" class="mb-3"></div>

            <div id="videoPlayer" style="display: none;">
                <video controls class="w-100 mb-3" style="max-height: 420px; border-radius: 12px;">
                    <source id="videoSource" type="video/mp4">
                    Ваш браузер не поддерживает видео элемент.
                </video>
            </div>

            <div class="d-flex flex-column flex-md-row gap-3 justify-content-center">
                <button type="button" class="btn btn-gsr-accent btn-lg px-4" onclick="downloadVideo()" id="downloadBtn" style="display: none;">
                    <i class="fas fa-download me-2"></i>Скачать видео
                </button>
                <button type="button" class="btn btn-outline-secondary btn-lg px-4" onclick="startNewVideo()">
                    <i class="fas fa-plus me-2"></i>Создать новое видео
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_scripts %}
<script>
let generatedTopics = [];
let selectedTopic = null;
let currentAudioUrl = null;
let currentVideoUrl = null;

// Показать статус с анимацией
function setStepStatus(stepId, type, message) {
    const statusId = `${stepId}Status`;
    GSRPipeline.showStatus(statusId, type, message);
    const statusDiv = document.getElementById(statusId);
    if (statusDiv) {
        statusDiv.style.display = 'block';
        statusDiv.classList.add('mt-3');
    }
}

// Скрыть статус
function hideStatus(stepId) {
    const statusDiv = document.getElementById(stepId + 'Status');
    GSRPipeline.resetStatus(statusDiv);
    if (statusDiv) {
        statusDiv.style.display = 'none';
    }
}

// Шаг 1: Генерация тем
async function generateTopics() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Генерация тем...';
    
    setStepStatus('topics', 'processing', '<i class="fas fa-brain me-2"></i>ИИ-ассистент генерирует 30 актуальных тем...');
    
    try {
        const response = await fetch('/api/experts/generate-topics', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ num_topics: 30 })
        });
        
        const result = await response.json();
        
        if (response.ok && result.topics) {
            generatedTopics = result.topics;
            setStepStatus('topics', 'success', `<i class="fas fa-check me-2"></i>Сгенерировано ${result.topics.length} тем! Переходим к выбору...`);
            
            setTimeout(() => {
                hideStatus('topics');
                displayTopics();
                GSRPipeline.enableStep('step2');
                GSRPipeline.activateStep('step2', { exclusive: true });
                document.getElementById('step2').scrollIntoView({ behavior: 'smooth' });
            }, 1500);
        } else {
            throw new Error(result.error || 'Не удалось сгенерировать темы');
        }
    } catch (error) {
        setStepStatus('topics', 'error', `<i class="fas fa-exclamation-triangle me-2"></i>Ошибка: ${error.message}`);
    } finally {
        button.disabled = false;
        button.innerHTML = originalText;
    }
}

// Функция для определения категории темы и CSS класса
function getTopicCategory(topic) {
    if (topic.includes('учёб') || topic.includes('студент') || topic.includes('опыт') || topic.includes('завтра')) {
        return { text: 'До 30 лет', class: 'young' };
    } else if (topic.includes('ипотек') || topic.includes('детьми') || topic.includes('семь') || topic.includes('долг')) {
        return { text: '30-45 лет', class: 'middle' };
    } else if (topic.includes('возраст') || topic.includes('50') || topic.includes('45')) {
        return { text: '45+ лет', class: 'senior' };
    } else {
        return { text: 'Для всех', class: '' };
    }
}

// Отображение тем как красивая таблица
function displayTopics() {
    const container = document.getElementById('topicsList');
    
    const tableRows = generatedTopics.map((topic, index) => {
        const category = getTopicCategory(topic);
        return `
            <tr>
                <td>
                    <div class="topic-number">${index + 1}</div>
                </td>
                <td>
                    <p class="topic-text">${topic}</p>
                </td>
                <td>
                    <span class="topic-category ${category.class}">${category.text}</span>
                </td>
                <td>
                    <button class="topic-btn" onclick="selectTopicAndGenerate(${index})">
                        <i class="fas fa-pen-alt"></i>Написать текст
                    </button>
                </td>
            </tr>
        `;
    }).join('');
    
    container.innerHTML = `
        <table>
            <thead>
                <tr>
                    <th>№</th>
                    <th>Тема</th>
                    <th>Аудитория</th>
                    <th>Действие</th>
                </tr>
            </thead>
            <tbody>
                ${tableRows}
            </tbody>
        </table>
    `;
}

// Выбор темы и переход к генерации текста
function selectTopicAndGenerate(index) {
    selectedTopic = {
        index: index,
        text: generatedTopics[index]
    };
    
    // Сразу переходим к генерации текста
    selectTopic();
}

// Переход к написанию текста
async function selectTopic() {
    if (!selectedTopic) {
        alert('Выберите тему');
        return;
    }
    
    setStepStatus('text', 'processing', '<i class="fas fa-pen-alt me-2"></i>ИИ-копирайтер пишет экспертный текст...');
    GSRPipeline.enableStep('step3');
    GSRPipeline.activateStep('step3', { exclusive: true });
    document.getElementById('step3').scrollIntoView({ behavior: 'smooth' });
    
    try {
        const response = await fetch('/api/experts/generate-text', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                topic: selectedTopic.text 
            })
        });
        
        const result = await response.json();
        
        if (response.ok && result.text) {
            document.getElementById('generatedText').value = result.text;
            setStepStatus('text', 'success', '<i class="fas fa-check me-2"></i>Текст сгенерирован! Отредактируйте при необходимости');
        } else {
            throw new Error(result.error || 'Не удалось сгенерировать текст');
        }
    } catch (error) {
        setStepStatus('text', 'error', `<i class="fas fa-exclamation-triangle me-2"></i>Ошибка: ${error.message}`);
    }
}

// Генерация аудио
async function generateAudio() {
    const text = document.getElementById('generatedText').value.trim();
    if (!text) {
        alert('Введите текст для озвучки');
        return;
    }
    
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Создание аудио...';
    
    setStepStatus('audio', 'processing', '<i class="fas fa-microphone me-2"></i>ElevenLabs генерирует аудио...');
    GSRPipeline.enableStep('step4');
    GSRPipeline.activateStep('step4', { exclusive: true });
    document.getElementById('step4').scrollIntoView({ behavior: 'smooth' });
    
    try {
        const modelId = document.getElementById('audioModel').value;
        const voiceId = document.getElementById('audioVoice').value;
        
        const response = await fetch('/api/generate-audio', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                text: text,
                model_id: modelId,
                voice_id: voiceId
            })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success && result.audio_url) {
            currentAudioUrl = result.audio_url;
            document.getElementById('audioSource').src = currentAudioUrl;
            document.getElementById('audioPlayer').style.display = 'block';
            document.getElementById('generateVideoBtn').style.display = 'inline-block';
            setStepStatus('audio', 'success', '<i class="fas fa-check me-2"></i>Аудио готово! Можете прослушать и создать видео');
        } else {
            throw new Error(result.message || 'Не удалось создать аудио');
        }
    } catch (error) {
        setStepStatus('audio', 'error', `<i class="fas fa-exclamation-triangle me-2"></i>Ошибка: ${error.message}`);
    } finally {
        button.disabled = false;
        button.innerHTML = originalText;
    }
}

// Генерация видео
async function generateVideo() {
    if (!currentAudioUrl) {
        alert('Сначала создайте аудио');
        return;
    }
    
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Создание видео...';
    
    setStepStatus('video', 'processing', '<i class="fas fa-video me-2"></i>HeyGen создает видео с говорящей головой...');
    GSRPipeline.enableStep('step5');
    GSRPipeline.activateStep('step5', { exclusive: true });
    document.getElementById('step5').scrollIntoView({ behavior: 'smooth' });
    
    try {
        const response = await fetch('/api/experts/generate-video', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                audio_url: currentAudioUrl,
                avatar_id: 'default_avatar'
            })
        });
        
        const result = await response.json();
        
        if (response.ok && result.video_url) {
            currentVideoUrl = result.video_url;
            document.getElementById('videoSource').src = currentVideoUrl;
            document.getElementById('videoPlayer').style.display = 'block';
            document.getElementById('downloadBtn').style.display = 'inline-block';
            setStepStatus('video', 'success', '<i class="fas fa-check me-2"></i>Видео готово! Экспертный контент создан успешно');
        } else {
            throw new Error(result.error || 'Не удалось создать видео');
        }
    } catch (error) {
        setStepStatus('video', 'error', `<i class="fas fa-exclamation-triangle me-2"></i>Ошибка: ${error.message}`);
    } finally {
        button.disabled = false;
        button.innerHTML = originalText;
    }
}

// Навигация назад
function backToTopics() {
    document.getElementById('step2').scrollIntoView({ behavior: 'smooth' });
}

function backToText() {
    document.getElementById('step3').scrollIntoView({ behavior: 'smooth' });
}

// Скачивание видео
function downloadVideo() {
    if (currentVideoUrl) {
        const a = document.createElement('a');
        a.href = currentVideoUrl;
        a.download = 'expert-video.mp4';
        a.click();
    }
}

// Загрузка голосов ElevenLabs
function loadVoices() {
    fetch('/api/elevenlabs/voices')
    .then(response => response.json())
    .then(data => {
        const voices = data.voices || [];
        const voiceSelect = document.getElementById('audioVoice');
        voiceSelect.innerHTML = '<option value="JBFqnCBsd6RMkjVDRZzb">Голос по умолчанию</option>';

        if (voices.length > 0) {
            voices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.voice_id;
                option.textContent = voice.name;
                voiceSelect.appendChild(option);
            });
        }
    })
    .catch(error => {
        console.log('Не удалось загрузить голоса:', error);
        document.getElementById('audioVoice').innerHTML = '<option value="JBFqnCBsd6RMkjVDRZzb">Голос по умолчанию</option>';
    });
}

// Начать заново
function startNewVideo() {
    if (confirm('Вы уверены, что хотите начать создание нового видео?')) {
        location.reload();
    }
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadVoices();
});
</script>
{% endblock %}
